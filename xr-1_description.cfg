# https://dcloud2-sng.cisco.com/content/demo/408682?returnPathTitleKey=content-view


# OSPFだけPre-Configされている
# ここはまだSR-MPLSではなくただのLDP MPLSの話
---default---

hostname XR1
telnet vrf default ipv4 server max-servers 50
telnet vrf Mgmt-intf ipv4 server max-servers 10
cdp
vrf Mgmt-intf
 address-family ipv4 unicast
 !
 address-family ipv6 unicast
 !
!
line template vty
 timestamp disable
 exec-timeout 720 0
!
line console
 timestamp disable
 exec-timeout 0 0
!
line default
 exec-timeout 720 0
!
interface Loopback0
 ipv4 address 10.10.1.1 255.255.255.255
!
interface MgmtEth0/0/CPU0/0
 vrf Mgmt-intf
 ipv4 address 198.18.1.31 255.255.255.0
!
interface GigabitEthernet0/0/0/0
 cdp
 ipv4 address 172.16.1.1 255.255.255.0
!
interface GigabitEthernet0/0/0/1
 cdp
 ipv4 address 172.16.3.1 255.255.255.0
!
router static
 vrf Mgmt-intf
  address-family ipv4 unicast
   10.16.0.0/16 198.18.1.1
   10.64.0.0/16 198.18.1.1
   198.18.128.0/18 198.18.1.1
  !
 !
!

# ここはまだLDP MPLSの話。SR-MPLSではない
#mpls ldp auto-config = 全てのInterfaceでLDP設定を自動的に投入
router ospf 100
 router-id 10.10.1.1
 area 0
  mpls ldp auto-config
  interface Loopback0
  !
  interface GigabitEthernet0/0/0/0
   network point-to-point
  !
  interface GigabitEthernet0/0/0/1
   network point-to-point
  !
 !
!
#RouterでのMPLSの有効化と、LDPネイバーが確立される
mpls ldp
!
end

---


RP/0/0/CPU0:XR1#show ip route ospf
Wed Dec  7 06:40:42.794 UTC

O    10.10.2.2/32 [110/2] via 172.16.1.2, 03:58:33, GigabitEthernet0/0/0/0
O    10.10.3.3/32 [110/2] via 172.16.3.3, 03:58:26, GigabitEthernet0/0/0/1
O    10.10.4.4/32 [110/3] via 172.16.3.3, 03:58:26, GigabitEthernet0/0/0/1
O    10.10.5.5/32 [110/3] via 172.16.1.2, 03:58:33, GigabitEthernet0/0/0/0
O    10.10.6.6/32 [110/4] via 172.16.3.3, 03:58:11, GigabitEthernet0/0/0/1
                  [110/4] via 172.16.1.2, 03:58:11, GigabitEthernet0/0/0/0
O    172.16.2.0/24 [110/2] via 172.16.1.2, 03:58:33, GigabitEthernet0/0/0/0
O    172.16.4.0/24 [110/2] via 172.16.3.3, 03:58:26, GigabitEthernet0/0/0/1
O    172.16.5.0/24 [110/3] via 172.16.1.2, 03:58:33, GigabitEthernet0/0/0/0
O    172.16.6.0/24 [110/3] via 172.16.3.3, 03:58:26, GigabitEthernet0/0/0/1
O    172.16.8.0/24 [110/3] via 172.16.3.3, 03:58:26, GigabitEthernet0/0/0/1

---

# LDP LabelはOSが自動的に付与する

# >ルーターは、ルーティングテーブルのエントリごとに”ローカルに”ラベルを割り当て、LDPネイバーにアドバタイズします。
# ローカルに割り当てたり、LDPネイバーから受信したラベル情報はLIBテーブルに保存されます。LIBテーブルの確認には、show mpls ldp bindingsコマンドを使います。
# https://www.n-study.com/mpls-and-mpls-vpn/mpls-basic-configuration-example/

# 10.10.1.1/32を見るとLocal Binding = ImpNullとして、ネイバーに対してラベルを外すよう通知している
# 10.10.1.1/32のPeerの10.10.2.2を見ると、10.10.1.1/32へのラベルとして24000を使うと通知されている

RP/0/0/CPU0:XR1#show mpls ldp bindings
Wed Dec  7 07:30:59.128 UTC

10.10.1.1/32, rev 2
        Local binding: label: ImpNull
        Remote bindings: (2 peers)
            Peer                Label
            -----------------   ---------
            10.10.2.2:0         24000
            10.10.3.3:0         24003
10.10.2.2/32, rev 9
        Local binding: label: 24000
        Remote bindings: (2 peers)
            Peer                Label
            -----------------   ---------
            10.10.2.2:0         ImpNull
            10.10.3.3:0         24004
10.10.3.3/32, rev 21
        Local binding: label: 24004
        Remote bindings: (2 peers)
            Peer                Label
            -----------------   ---------
            10.10.2.2:0         24004
            10.10.3.3:0         ImpNull
10.10.4.4/32, rev 22
        Local binding: label: 24005
        Remote bindings: (2 peers)
            Peer                Label
            -----------------   ---------
            10.10.2.2:0         24006
            10.10.3.3:0         24000
10.10.5.5/32, rev 10
        Local binding: label: 24001
        Remote bindings: (2 peers)
            Peer                Label
            -----------------   ---------
            10.10.2.2:0         24002
            10.10.3.3:0         24009
10.10.6.6/32, rev 26
        Local binding: label: 24009
        Remote bindings: (2 peers)
            Peer                Label
            -----------------   ---------
            10.10.2.2:0         24007
            10.10.3.3:0         24007
172.16.1.0/24, rev 4
        Local binding: label: ImpNull
        Remote bindings: (2 peers)
            Peer                Label
            -----------------   ---------
            10.10.2.2:0         ImpNull
            10.10.3.3:0         24005
172.16.2.0/24, rev 19
        Local binding: label: 24002
        Remote bindings: (2 peers)
            Peer                Label
            -----------------   ---------
            10.10.2.2:0         ImpNull
            10.10.3.3:0         24006
172.16.3.0/24, rev 6
        Local binding: label: ImpNull
        Remote bindings: (2 peers)
            Peer                Label
            -----------------   ---------
            10.10.2.2:0         24001
            10.10.3.3:0         ImpNull
172.16.4.0/24, rev 23
        Local binding: label: 24006
        Remote bindings: (2 peers)
            Peer                Label
            -----------------   ---------
            10.10.2.2:0         24005
            10.10.3.3:0         ImpNull
172.16.5.0/24, rev 20
        Local binding: label: 24003
        Remote bindings: (2 peers)
            Peer                Label
            -----------------   ---------
            10.10.2.2:0         24003
            10.10.3.3:0         24008
172.16.6.0/24, rev 24
        Local binding: label: 24007
        Remote bindings: (2 peers)
            Peer                Label
            -----------------   ---------
            10.10.2.2:0         24008
            10.10.3.3:0         24001
172.16.8.0/24, rev 25
        Local binding: label: 24008
        Remote bindings: (2 peers)
            Peer                Label
            -----------------   ---------
            10.10.2.2:0         24009
            10.10.3.3:0         24002

# 実際に、xr-2のldp table = LIBを見ると、Local Labelは24000となっている
RP/0/0/CPU0:XR2#show mpls ldp bindings
Wed Dec  7 07:39:18.484 UTC

10.10.1.1/32, rev 17
        Local binding: label: 24000
        Remote bindings: (2 peers)
            Peer                Label
            -----------------   ---------
            10.10.1.1:0         ImpNull
            10.10.5.5:0         24000

#Implicit Null = ラベルを外す＝PoP（ここに転送するためにはMPLSはもう必要ないから）
#この場合、ImpNullは自分のLoとInterfaceになっている

RP/0/0/CPU0:XR1#show mpls ldp bindings brief
Wed Dec  7 06:52:50.975 UTC

Prefix              Local      Advertised  Remote Bindings
                    Label        (peers)       (peers)
------------------  ---------  ----------  ---------------
10.10.1.1/32        ImpNull             2                2
10.10.2.2/32        24000               2                2
10.10.3.3/32        24004               2                2
10.10.4.4/32        24005               2                2
10.10.5.5/32        24001               2                2
10.10.6.6/32        24009               2                2
172.16.1.0/24       ImpNull             2                2
172.16.2.0/24       24002               2                2
172.16.3.0/24       ImpNull             2                2
172.16.4.0/24       24006               2                2
172.16.5.0/24       24003               2                2
172.16.6.0/24       24007               2                2
172.16.8.0/24       24008               2                2


---

# Local及びIGP+LDPで広報されたラベルをもとにして、LFIBテーブルを作成

RP/0/0/CPU0:XR1#show mpls forwarding
Wed Dec  7 06:57:51.134 UTC
Local  Outgoing    Prefix             Outgoing     Next Hop        Bytes
Label  Label       or ID              Interface                    Switched
------ ----------- ------------------ ------------ --------------- ------------
24000  Pop         10.10.2.2/32       Gi0/0/0/0    172.16.1.2      28820
24001  24002       10.10.5.5/32       Gi0/0/0/0    172.16.1.2      0
24002  Pop         172.16.2.0/24      Gi0/0/0/0    172.16.1.2      0
24003  24003       172.16.5.0/24      Gi0/0/0/0    172.16.1.2      0
24004  Pop         10.10.3.3/32       Gi0/0/0/1    172.16.3.3      28940
24005  24000       10.10.4.4/32       Gi0/0/0/1    172.16.3.3      0
24006  Pop         172.16.4.0/24      Gi0/0/0/1    172.16.3.3      0
24007  24001       172.16.6.0/24      Gi0/0/0/1    172.16.3.3      0
24008  24002       172.16.8.0/24      Gi0/0/0/1    172.16.3.3      0
24009  24007       10.10.6.6/32       Gi0/0/0/0    172.16.1.2      0
       24007       10.10.6.6/32       Gi0/0/0/1    172.16.3.3      0

---

# traceroute上、xr-2へ送信している

RP/0/0/CPU0:XR1#traceroute 10.10.6.6 source 10.10.1.1 verbose
Wed Dec  7 07:03:37.510 UTC

Type escape sequence to abort.
Tracing the route to 10.10.6.6

 1  172.16.1.2 [MPLS: Label 24007 Exp 0] 39 msec  9 msec  9 msec
 2  172.16.2.5 [MPLS: Label 24006 Exp 0] 9 msec  0 msec  0 msec
 3  172.16.5.6 9 msec  *  0 msec


# cefを見ると、xr-1のFIBでは、10.10.6.6/32はr-2とxr-3でECMPされている
# xr-2(172.16.1.2)へ転送する場合、local label 24009を見て、パケットにlabel 24007をつけて送信している
# この24007というラベルを付けるのは、LDPによってxr-2から広報されたからである

10.10.6.6/32, rev 26
        Local binding: label: 24009
        Remote bindings: (2 peers)
            Peer                Label
            -----------------   ---------
            10.10.2.2:0         24007
            10.10.3.3:0         24007


RP/0/0/CPU0:XR1#show cef 10.10.6.6/32 detail
Wed Dec  7 07:57:20.010 UTC
10.10.6.6/32, version 25, internal 0x1000001 0x0 (ptr 0xa13fc774) [1], 0x0 (0xa13de9b8), 0xa28 (0xa19dd0b8)
 Updated Dec  7 02:43:01.362
 local adjacency 172.16.1.2
 Prefix Len 32, traffic index 0, precedence n/a, priority 3
  gateway array (0xa13358f4) reference count 3, flags 0x68, source lsd (5), 1 backups
                [2 type 5 flags 0x8401 (0xa1773518) ext 0x0 (0x0)]
  LW-LDI[type=5, refc=3, ptr=0xa13de9b8, sh-ldi=0xa1773518]
  gateway array update type-time 1 Dec  7 02:43:01.362
 LDI Update time Dec  7 02:43:01.362
 LW-LDI-TS Dec  7 02:43:01.362
   via 172.16.1.2/32, GigabitEthernet0/0/0/0, 7 dependencies, weight 0, class 0 [flags 0x0]
    path-idx 0 NHID 0x0 [0xa189b3d0 0x0]
    next hop 172.16.1.2/32
    local adjacency
     local label 24009      labels imposed {24007}
   via 172.16.3.3/32, GigabitEthernet0/0/0/1, 7 dependencies, weight 0, class 0 [flags 0x0]
    path-idx 1 NHID 0x0 [0xa189b480 0x0]
    next hop 172.16.3.3/32
    local adjacency
     local label 24009      labels imposed {24007}


    Load distribution: 0 1 (refcount 2)

    Hash  OK  Interface                 Address
    0     Y   GigabitEthernet0/0/0/0    172.16.1.2
    1     Y   GigabitEthernet0/0/0/1    172.16.3.3




# xr-2のLFIBを見ると、Local Label24007は、10.10.6.6/32のPrefix宛に付いていて、Outgoing label 24006を付けてxr-5へ転送

RP/0/0/CPU0:XR2#show mpls forwarding
Wed Dec  7 08:03:20.305 UTC
Local  Outgoing    Prefix             Outgoing     Next Hop        Bytes
Label  Label       or ID              Interface                    Switched
------ ----------- ------------------ ------------ --------------- ------------
24000  Pop         10.10.1.1/32       Gi0/0/0/0    172.16.1.1      38093
24001  Pop         172.16.3.0/24      Gi0/0/0/0    172.16.1.1      0
24002  Pop         10.10.5.5/32       Gi0/0/0/1    172.16.2.5      36268
24003  Pop         172.16.5.0/24      Gi0/0/0/1    172.16.2.5      0
24004  24004       10.10.3.3/32       Gi0/0/0/0    172.16.1.1      0
24005  24006       172.16.4.0/24      Gi0/0/0/0    172.16.1.1      0
24006  24005       10.10.4.4/32       Gi0/0/0/0    172.16.1.1      0
       24005       10.10.4.4/32       Gi0/0/0/1    172.16.2.5      0
24007  24006       10.10.6.6/32       Gi0/0/0/1    172.16.2.5      2376
24008  24008       172.16.6.0/24      Gi0/0/0/1    172.16.2.5      0
24009  24009       172.16.8.0/24      Gi0/0/0/1    172.16.2.5      0

# xr-5のLFIBではLocal 24006はPoPし、xr-6へ転送
# labelはpopされているため、xr-6では通常のルーティングでloopback = 10.10.6.6へ転送

RP/0/0/CPU0:XR5#show mpls forwarding
Wed Dec  7 08:09:43.259 UTC
Local  Outgoing    Prefix             Outgoing     Next Hop        Bytes
Label  Label       or ID              Interface                    Switched
------ ----------- ------------------ ------------ --------------- ------------
24000  24000       10.10.1.1/32       Gi0/0/0/0    172.16.2.2      1548
24001  Pop         10.10.2.2/32       Gi0/0/0/0    172.16.2.2      37311
24002  Pop         172.16.1.0/24      Gi0/0/0/0    172.16.2.2      0
24003  24001       172.16.3.0/24      Gi0/0/0/0    172.16.2.2      0
24004  24004       10.10.3.3/32       Gi0/0/0/0    172.16.2.2      0
       24000       10.10.3.3/32       Gi0/0/0/1    172.16.5.6      0
24005  24001       10.10.4.4/32       Gi0/0/0/1    172.16.5.6      0
24006  Pop         10.10.6.6/32       Gi0/0/0/1    172.16.5.6      40442
24007  24003       172.16.4.0/24      Gi0/0/0/1    172.16.5.6      0
24008  Pop         172.16.6.0/24      Gi0/0/0/1    172.16.5.6      0
24009  Pop         172.16.8.0/24      Gi0/0/0/1    172.16.5.6      0



---

# MPLS oam = MPLSを監視する機能
# 全てのルーターに設定が必要
conf t
mpls oam

# traceroute mpls multipathは、宛先までのECMPパスを全て検出できる
# 以下Path 2はUnexplorable、つまり宛先までのパスはPath 0,1の２つあることになる



RP/0/0/CPU0:XR1#traceroute mpls multipath ipv4 10.10.6.6/32 source 10.10.1.1 ver
Wed Dec  7 08:27:39.835 UTC

Starting LSP Path Discovery for 10.10.6.6/32

Codes: '!' - success, 'Q' - request not sent, '.' - timeout,
  'L' - labeled output interface, 'B' - unlabeled output interface,
  'D' - DS Map mismatch, 'F' - no FEC mapping, 'f' - FEC mismatch,
  'M' - malformed request, 'm' - unsupported tlvs, 'N' - no rx label,
  'P' - no rx intf label prot, 'p' - premature termination of LSP,
  'R' - transit router, 'I' - unknown upstream index,
  'X' - unknown return code, 'x' - return code 0

Type escape sequence to abort.

LL!
Path 0 found,
 output interface GigabitEthernet0/0/0/0 nexthop 172.16.1.2
 source 10.10.1.1 destination 127.0.0.0
  0 10.10.1.1 172.16.1.2 MRU 1500 [Labels: 24007 Exp: 0] multipaths 0
L 1 172.16.1.2 172.16.2.5 MRU 1500 [Labels: 24006 Exp: 0] ret code 8 multipaths 1
L 2 172.16.2.5 172.16.5.6 MRU 1500 [Labels: implicit-null Exp: 0] ret code 8 multipaths 1
! 3 172.16.5.6, ret code 3 multipaths 0
LL!
Path 1 found,
 output interface GigabitEthernet0/0/0/1 nexthop 172.16.3.3
 source 10.10.1.1 destination 127.0.0.1
  0 10.10.1.1 172.16.3.3 MRU 1500 [Labels: 24007 Exp: 0] multipaths 0
L 1 172.16.3.3 172.16.4.4 MRU 1500 [Labels: 24004 Exp: 0] ret code 8 multipaths 1
L 2 172.16.4.4 172.16.6.6 MRU 1500 [Labels: implicit-null Exp: 0] ret code 8 multipaths 2
! 3 172.16.6.6, ret code 3 multipaths 0
...
Path 2 Unexplorable,
 output interface GigabitEthernet0/0/0/1 nexthop 172.16.3.3
 source 10.10.1.1 destination 127.0.0.0
  0 10.10.1.1 172.16.3.3 MRU 1500 [Labels: 24007 Exp: 0] multipaths 0
L 1 172.16.3.3 172.16.4.4 MRU 1500 [Labels: 24004 Exp: 0] ret code 8 multipaths 1
L 2 172.16.4.4 172.16.8.6 MRU 1500 [Labels: implicit-null Exp: 0] ret code 8 multipaths 2

Paths (found/broken/unexplored) (2/0/1)
 Echo Request (sent/fail) (9/0)
 Echo Reply (received/timeout) (6/3)
 Total Time Elapsed 5 seconds 819 ms


---

---Segment Routingの有効化=SR-MPLSの話---

# segment routingの設定をOSPF Global配下に投入する
router ospf 100
 segment-routing mpls
 segment-routing forwarding mpls

# show run 
router ospf 100
 router-id 10.10.1.1
 segment-routing mpls
 segment-routing forwarding mpls
 area 0
  mpls ldp auto-config
  interface Loopback0
  !
  interface GigabitEthernet0/0/0/0
   network point-to-point
  !
  interface GigabitEthernet0/0/0/1
   network point-to-point
  !
 !
!


# show mpls label table - 使われているラベル一覧表示
# SRGBは16000-24000で自動的に払い出される
# ラベルは自動的に払い出される？Poolとかの設定は不要で？

# ospf-100は、SRGBとしてlabel 16000を使用

RP/0/0/CPU0:XR1#show mpls label table
Wed Dec  7 08:46:34.287 UTC
Table Label   Owner                           State  Rewrite
----- ------- ------------------------------- ------ -------
0     0       LSD(A)                          InUse  Yes
0     1       LSD(A)                          InUse  Yes
0     2       LSD(A)                          InUse  Yes
0     13      LSD(A)                          InUse  Yes
0     16000   OSPF(A):ospf-100                InUse  No
0     24000   LDP(A)                          InUse  Yes
0     24001   LDP(A)                          InUse  Yes
0     24002   LDP(A)                          InUse  Yes
0     24003   LDP(A)                          InUse  Yes
0     24004   LDP(A)                          InUse  Yes
0     24005   LDP(A)                          InUse  Yes
0     24006   LDP(A)                          InUse  Yes
0     24007   LDP(A)                          InUse  Yes
0     24008   LDP(A)                          InUse  Yes
0     24009   LDP(A)                          InUse  Yes
0     24010   OSPF(A):ospf-100                InUse  Yes
0     24011   OSPF(A):ospf-100                InUse  Yes

RP/0/0/CPU0:XR1#show mpls label table detail
Wed Dec  7 08:46:41.717 UTC
Table Label   Owner                           State  Rewrite
----- ------- ------------------------------- ------ -------
0     0       LSD(A)                          InUse  Yes
0     1       LSD(A)                          InUse  Yes
0     2       LSD(A)                          InUse  Yes
0     13      LSD(A)                          InUse  Yes
0     16000   OSPF(A):ospf-100                InUse  No
  (Lbl-blk SRGB, vers:0, (start_label=16000, size=8000)
0     24000   LDP(A)                          InUse  Yes
  (IPv4, vers:0, 'default':4U, 10.10.2.2/32)
0     24001   LDP(A)                          InUse  Yes
  (IPv4, vers:0, 'default':4U, 10.10.5.5/32)
0     24002   LDP(A)                          InUse  Yes
  (IPv4, vers:0, 'default':4U, 172.16.2.0/24)
0     24003   LDP(A)                          InUse  Yes
  (IPv4, vers:0, 'default':4U, 172.16.5.0/24)
0     24004   LDP(A)                          InUse  Yes
  (IPv4, vers:0, 'default':4U, 10.10.3.3/32)
0     24005   LDP(A)                          InUse  Yes
  (IPv4, vers:0, 'default':4U, 10.10.4.4/32)
0     24006   LDP(A)                          InUse  Yes
  (IPv4, vers:0, 'default':4U, 172.16.4.0/24)
0     24007   LDP(A)                          InUse  Yes
  (IPv4, vers:0, 'default':4U, 172.16.6.0/24)
0     24008   LDP(A)                          InUse  Yes
  (IPv4, vers:0, 'default':4U, 172.16.8.0/24)
0     24009   LDP(A)                          InUse  Yes
  (IPv4, vers:0, 'default':4U, 10.10.6.6/32)
0     24010   OSPF(A):ospf-100                InUse  Yes
  (SR Adj Segment IPv4, vers:0, index=0, type=2, intf=Gi0/0/0/0, nh=172.16.1.2)
0     24011   OSPF(A):ospf-100                InUse  Yes
  (SR Adj Segment IPv4, vers:0, index=0, type=2, intf=Gi0/0/0/1, nh=172.16.3.3)



# Adj-SIDの確認
# Adj-SIDはunprotectedになっている。TI-LFAがEnableになると、Adj-SIDがProtectedになる
# Adj-SIDも自動付与？

RP/0/0/CPU0:XR1#show ospf neighbor detail
Wed Dec  7 09:13:50.075 UTC

* Indicates MADJ interface
# Indicates Neighbor awaiting BFD session up

Neighbors for OSPF 100

 Neighbor 10.10.2.2, interface address 172.16.1.2
    In the area 0 via interface GigabitEthernet0/0/0/0
    Neighbor priority is 1, State is FULL, 6 state changes
    DR is 0.0.0.0 BDR is 0.0.0.0
    Options is 0x52
    LLS Options is 0x1 (LR)
    Dead timer due in 00:00:38
    Neighbor is up for 06:31:42
    Number of DBD retrans during last exchange 0
    Index 1/1, retransmission queue length 0, number of retransmission 5
    First 0(0)/0(0) Next 0(0)/0(0)
    Last retransmission scan length is 2, maximum is 2
    Last retransmission scan time is 0 msec, maximum is 0 msec
    LS Ack list: NSR-sync pending 0, high water mark 0
    # xr-2へのAdj SIDは24010
    Unprotected Adjacency SID Label: 24010
    Neighbor Interface ID: 3

 Neighbor 10.10.3.3, interface address 172.16.3.3
    In the area 0 via interface GigabitEthernet0/0/0/1
    Neighbor priority is 1, State is FULL, 6 state changes
    DR is 0.0.0.0 BDR is 0.0.0.0
    Options is 0x52
    LLS Options is 0x1 (LR)
    Dead timer due in 00:00:37
    Neighbor is up for 06:31:36
    Number of DBD retrans during last exchange 0
    Index 2/2, retransmission queue length 0, number of retransmission 3
    First 0(0)/0(0) Next 0(0)/0(0)
    Last retransmission scan length is 2, maximum is 2
    Last retransmission scan time is 0 msec, maximum is 0 msec
    LS Ack list: NSR-sync pending 0, high water mark 0
    # xr-3へのAdj SIDは24011
    Unprotected Adjacency SID Label: 24011
    Neighbor Interface ID: 3

Total neighbor count: 2

---Node SIDをLoopbackに付与---

# prefix-sid index 1の意味
# 実際のラベルはSRGB + index、この場合は16000 + 1 = 160001が付与される
# 明示的に振りたい場合は、prefix-sid absolute xxx でもい
 
router ospf 100
 area 0
  interface Loopback0
   prefix-sid index 1



# OSPFで、自分がSegment情報を広報していることを確認
# 当然、他のルーターからもSIDは広報されている
# Opaque LSA とは、ベンダが OSPF プロトコル上で自由にアプリケーションに関する情報を載せられるように用意された拡張フィールドで、1998 年に RFC2370 で定められ、2008 年の RFC 5250 で改定されました。

RP/0/0/CPU0:XR1#show ospf database opaque-area self-originate
Wed Dec  7 09:43:31.783 UTC


            OSPF Router with ID (10.10.1.1) (Process ID 100)

                Type-10 Opaque Link Area Link States (Area 0)

  LS age: 1630
  Options: (No TOS-capability, DC)
  LS Type: Opaque Area Link
  Link State ID: 1.0.0.0
  Opaque Type: 1
  Opaque ID: 0
  Advertising Router: 10.10.1.1
  LS Seq Number: 80000002
  Checksum: 0x44c0
  Length: 28

    MPLS TE router ID : 10.10.1.1

    Number of Links : 0

  LS age: 1630
  Options: (No TOS-capability, DC)
  LS Type: Opaque Area Link
  Link State ID: 1.0.0.3
  Opaque Type: 1
  Opaque ID: 3
  Advertising Router: 10.10.1.1
  LS Seq Number: 80000002
  Checksum: 0xefa5
  Length: 80

    Link connected to Point-to-Point network
      Link ID : 10.10.2.2
      (all bandwidths in bytes/sec)
      Interface Address : 172.16.1.1
      Neighbor Address : 172.16.1.2
      Admin Metric : 1
      Maximum bandwidth : 125000000
      IGP Metric : 1

    Number of Links : 1

  LS age: 1630
  Options: (No TOS-capability, DC)
  LS Type: Opaque Area Link
  Link State ID: 1.0.0.4
  Opaque Type: 1
  Opaque ID: 4
  Advertising Router: 10.10.1.1
  LS Seq Number: 80000002
  Checksum: 0xbbd1
  Length: 80

    Link connected to Point-to-Point network
      Link ID : 10.10.3.3
      (all bandwidths in bytes/sec)
      Interface Address : 172.16.3.1
      Neighbor Address : 172.16.3.3
      Admin Metric : 1
      Maximum bandwidth : 125000000
      IGP Metric : 1

    Number of Links : 1



# ここが大事っぽい

  LS age: 1630
  Options: (No TOS-capability, DC)
  LS Type: Opaque Area Link
  Link State ID: 4.0.0.0
  Opaque Type: 4
  Opaque ID: 0
  Advertising Router: 10.10.1.1
  LS Seq Number: 80000003
  Checksum: 0x55e5
  Length: 60

    Router Information TLV: Length: 4
    Capabilities:
      Graceful Restart Helper Capable
      Stub Router Capable
      All capability bits: 0x60000000

    Segment Routing Algorithm TLV: Length: 2
      Algorithm: 0
      Algorithm: 1

    Segment Routing Range TLV: Length: 12
      Range Size: 8000

        SID sub-TLV: Length 3
         Label: 16000

    Node MSD TLV: Length: 2
        Type: 1, Value 10

  LS age: 790
  Options: (No TOS-capability, DC)
  LS Type: Opaque Area Link
  Link State ID: 7.0.0.1
  Opaque Type: 7
  Opaque ID: 1
  Advertising Router: 10.10.1.1
  LS Seq Number: 80000001
  Checksum: 0x1c56
  Length: 44
　
# 広報しているPrefixとSIDのIndex
    Extended Prefix TLV: Length: 20
      Route-type: 1
      AF        : 0
      Flags     : 0x40
      Prefix    : 10.10.1.1/32

      SID sub-TLV: Length: 8
        Flags     : 0x0
        MTID      : 0
        Algo      : 0
        SID Index : 1

  LS age: 1630
  Options: (No TOS-capability, DC)
  LS Type: Opaque Area Link
  Link State ID: 8.0.0.3
  Opaque Type: 8
  Opaque ID: 3
  Advertising Router: 10.10.1.1
  LS Seq Number: 80000003
  Checksum: 0x83bb
  Length: 100

    Extended Link TLV: Length: 76
      Link-type : 1
      Link ID   : 10.10.2.2
      Link Data : 172.16.1.1

     Adj sub-TLV: Length: 7
        Flags     : 0x60
        MTID      : 0
        Weight    : 0
        Label     : 24010

     Local-ID Remote-ID sub-TLV: Length: 8
        Local Interface ID: 3
        Remote Interface ID: 3

     Remote If Address sub-TLV: Length: 4
        Neighbor Address: 172.16.1.2

     Link MSD sub-TLV: Length: 2
        Type: 1, Value 10

  LS age: 1630
  Options: (No TOS-capability, DC)
  LS Type: Opaque Area Link
  Link State ID: 8.0.0.4
  Opaque Type: 8
  Opaque ID: 4
  Advertising Router: 10.10.1.1
  LS Seq Number: 80000003
  Checksum: 0xd15f
  Length: 100

# Adj-SIDの広報
    Extended Link TLV: Length: 76
      Link-type : 1
      Link ID   : 10.10.3.3
      Link Data : 172.16.3.1

     Adj sub-TLV: Length: 7
        Flags     : 0x60
        MTID      : 0
        Weight    : 0
        Label     : 24011

     Local-ID Remote-ID sub-TLV: Length: 8
        Local Interface ID: 4
        Remote Interface ID: 3

     Remote If Address sub-TLV: Length: 4
        Neighbor Address: 172.16.3.3

     Link MSD sub-TLV: Length: 2
        Type: 1, Value 10


# LFIBの確認
# 16002-16006は他のNode-SID, xr-2,xr-3は隣接しているのでLabelはPopする
# ImpNull表示ではないんやな...?

# SR Pfx, SR-AdjがSR-MPLSで使われるSID

RP/0/0/CPU0:XR1#show mpls forwarding
Wed Dec  7 09:53:01.614 UTC
Local  Outgoing    Prefix             Outgoing     Next Hop        Bytes
Label  Label       or ID              Interface                    Switched
------ ----------- ------------------ ------------ --------------- ------------
16002  Pop         SR Pfx (idx 2)     Gi0/0/0/0    172.16.1.2      0
16003  Pop         SR Pfx (idx 3)     Gi0/0/0/1    172.16.3.3      0
16004  16004       SR Pfx (idx 4)     Gi0/0/0/1    172.16.3.3      0
16005  16005       SR Pfx (idx 5)     Gi0/0/0/0    172.16.1.2      0
16006  16006       SR Pfx (idx 6)     Gi0/0/0/0    172.16.1.2      0
       16006       SR Pfx (idx 6)     Gi0/0/0/1    172.16.3.3      0
24000  Pop         10.10.2.2/32       Gi0/0/0/0    172.16.1.2      2156
24001  24002       10.10.5.5/32       Gi0/0/0/0    172.16.1.2      0
24002  Pop         172.16.2.0/24      Gi0/0/0/0    172.16.1.2      0
24003  24003       172.16.5.0/24      Gi0/0/0/0    172.16.1.2      0
24004  Pop         10.10.3.3/32       Gi0/0/0/1    172.16.3.3      2156
24005  24000       10.10.4.4/32       Gi0/0/0/1    172.16.3.3      0
24006  Pop         172.16.4.0/24      Gi0/0/0/1    172.16.3.3      0
24007  24001       172.16.6.0/24      Gi0/0/0/1    172.16.3.3      0
24008  24002       172.16.8.0/24      Gi0/0/0/1    172.16.3.3      0
24009  24007       10.10.6.6/32       Gi0/0/0/0    172.16.1.2      0
       24007       10.10.6.6/32       Gi0/0/0/1    172.16.3.3      0
24010  Pop         SR Adj (idx 0)     Gi0/0/0/0    172.16.1.2      0
24011  Pop         SR Adj (idx 0)     Gi0/0/0/1    172.16.3.3      0


# 10.10.6.6までtracerouteしてみる
# SR-MPLSのSID(16006)ではなく、LDPのSIDがまだ使われている
# LDPとSR-MPLSが両方使われている場合、LDPの方が優先される->LDPからSR-MPLSの移行を簡単ん日するため


RP/0/0/CPU0:XR1#traceroute 10.10.6.6 source 10.10.1.1
Wed Dec  7 09:57:37.875 UTC

Type escape sequence to abort.
Tracing the route to 10.10.6.6

 1  172.16.1.2 [MPLS: Label 24007 Exp 0] 9 msec  9 msec  0 msec
 2  172.16.2.5 [MPLS: Label 24006 Exp 0] 0 msec  0 msec  0 msec
 3  172.16.5.6 9 msec  *  9 msec


# SR-MPLSをLDPより優先させる

router ospf 100
 segment-routing sr-prefer


# SR-MPLS SIDが使われるようになった

RP/0/0/CPU0:XR1#traceroute 10.10.6.6 source 10.10.1.1
Wed Dec  7 10:05:01.015 UTC

Type escape sequence to abort.
Tracing the route to 10.10.6.6

 1  172.16.1.2 [MPLS: Label 16006 Exp 0] 19 msec  9 msec  9 msec
 2  172.16.2.5 [MPLS: Label 16006 Exp 0] 9 msec  9 msec  9 msec
 3  172.16.5.6 9 msec  *  9 msec


# cef上もlabel 16006がつけられるようになっている
RP/0/0/CPU0:XR1#show cef detail
10.10.6.6/32, version 42, labeled SR, internal 0x1000001 0x83 (ptr 0xa13fc774) [1], 0x0 (0xa13decd8), 0xa28 (0xa19dd0b8)
 Updated Oct  9 22:32:16.512
 local adjacency 172.16.1.2
 Prefix Len 32, traffic index 0, precedence n/a, priority 1
   via 172.16.1.2/32, GigabitEthernet0/0/0/0, 17 dependencies, weight 0, class 0 [flags 0x0]
    path-idx 0 NHID 0x0 [0xa189b3d0 0x0]
    next hop 172.16.1.2/32
    local adjacency
     local label 16006      labels imposed {16006}
   via 172.16.3.3/32, GigabitEthernet0/0/0/1, 17 dependencies, weight 0, class 0 [flags 0x0]
    path-idx 1 NHID 0x0 [0xa189b480 0x0]
    next hop 172.16.3.3/32
    local adjacency
     local label 16006      labels imposed {16006}


# いまだにPathは２つしかない

RP/0/0/CPU0:XR1# ping sr-mpls 10.10.6.6/32 source 10.10.1.1 ver
Wed Dec  7 10:07:02.256 UTC

Sending 5, 100-byte MPLS Echos to 10.10.6.6/32,
      timeout is 2 seconds, send interval is 0 msec:

Codes: '!' - success, 'Q' - request not sent, '.' - timeout,
  'L' - labeled output interface, 'B' - unlabeled output interface,
  'D' - DS Map mismatch, 'F' - no FEC mapping, 'f' - FEC mismatch,
  'M' - malformed request, 'm' - unsupported tlvs, 'N' - no rx label,
  'P' - no rx intf label prot, 'p' - premature termination of LSP,
  'R' - transit router, 'I' - unknown upstream index,
  'X' - unknown return code, 'x' - return code 0

Type escape sequence to abort.

!      size 100, reply addr 172.16.6.6, return code 3
!      size 100, reply addr 172.16.6.6, return code 3
!      size 100, reply addr 172.16.6.6, return code 3
!      size 100, reply addr 172.16.6.6, return code 3
!      size 100, reply addr 172.16.6.6, return code 3

Success rate is 100 percent (5/5), round-trip min/avg/max = 1/8/20 ms
RP/0/0/CPU0:XR1#traceroute sr-mpls multipath 10.10.6.6/32 source 10.10.1.1 ver
Wed Dec  7 10:07:20.655 UTC

Starting LSP Path Discovery for 10.10.6.6/32

Codes: '!' - success, 'Q' - request not sent, '.' - timeout,
  'L' - labeled output interface, 'B' - unlabeled output interface,
  'D' - DS Map mismatch, 'F' - no FEC mapping, 'f' - FEC mismatch,
  'M' - malformed request, 'm' - unsupported tlvs, 'N' - no rx label,
  'P' - no rx intf label prot, 'p' - premature termination of LSP,
  'R' - transit router, 'I' - unknown upstream index,
  'X' - unknown return code, 'x' - return code 0

Type escape sequence to abort.

LL!
Path 0 found,
 output interface GigabitEthernet0/0/0/0 nexthop 172.16.1.2
 source 10.10.1.1 destination 127.0.0.0
  0 10.10.1.1 172.16.1.2 MRU 1500 [Labels: 16006 Exp: 0] multipaths 0
L 1 172.16.1.2 172.16.2.5 MRU 1500 [Labels: 16006 Exp: 0] ret code 8 multipaths 1
L 2 172.16.2.5 172.16.5.6 MRU 1500 [Labels: implicit-null Exp: 0] ret code 8 multipaths 1
! 3 172.16.5.6, ret code 3 multipaths 0
LL!
Path 1 found,
 output interface GigabitEthernet0/0/0/1 nexthop 172.16.3.3
 source 10.10.1.1 destination 127.0.0.1
  0 10.10.1.1 172.16.3.3 MRU 1500 [Labels: 16006 Exp: 0] multipaths 0
L 1 172.16.3.3 172.16.4.4 MRU 1500 [Labels: 16006 Exp: 0] ret code 8 multipaths 1
L 2 172.16.4.4 172.16.6.6 MRU 1500 [Labels: implicit-null Exp: 0] ret code 8 multipaths 2
! 3 172.16.6.6, ret code 3 multipaths 0
...
Path 2 Unexplorable,
 output interface GigabitEthernet0/0/0/1 nexthop 172.16.3.3
 source 10.10.1.1 destination 127.0.0.0
  0 10.10.1.1 172.16.3.3 MRU 1500 [Labels: 16006 Exp: 0] multipaths 0
L 1 172.16.3.3 172.16.4.4 MRU 1500 [Labels: 16006 Exp: 0] ret code 8 multipaths 1
L 2 172.16.4.4 172.16.8.6 MRU 1500 [Labels: implicit-null Exp: 0] ret code 8 multipaths 2

Paths (found/broken/unexplored) (2/0/1)
 Echo Request (sent/fail) (9/0)
 Echo Reply (received/timeout) (6/3)
 Total Time Elapsed 5 seconds 789 ms


---LDPをDisableする---


router ospf 100
 area 0
  no mpls ldp auto-config
 !
!
no mpls ldp
end

RP/0/0/CPU0:XR1#show mpls interfaces
Thu Dec  8 02:07:54.083 UTC
Interface                  LDP      Tunnel   Static   Enabled
-------------------------- -------- -------- -------- --------
GigabitEthernet0/0/0/0     No       No       No       Yes
GigabitEthernet0/0/0/1     No       No       No       Yes


# xr-4,xr-5からSRーMPLS設定を削除すると、LDPとSR-MPLSが共存するNWになる

# xr-4=16004, xr-5=16005はSR-MPLSが動いていないTransit Nodeになっているため、LFIBにも載っていない
RP/0/0/CPU0:XR1#show mpls forwarding
Thu Dec  8 02:27:44.291 UTC
Local  Outgoing    Prefix             Outgoing     Next Hop        Bytes
Label  Label       or ID              Interface                    Switched
------ ----------- ------------------ ------------ --------------- ------------
16002  Pop         SR Pfx (idx 2)     Gi0/0/0/0    172.16.1.2      2397
16003  Pop         SR Pfx (idx 3)     Gi0/0/0/1    172.16.3.3      2259
16006  16006       SR Pfx (idx 6)     Gi0/0/0/0    172.16.1.2      288
       16006       SR Pfx (idx 6)     Gi0/0/0/1    172.16.3.3      0
24010  Pop         SR Adj (idx 0)     Gi0/0/0/0    172.16.1.2      0
24011  Pop         SR Adj (idx 0)     Gi0/0/0/1    172.16.3.3      0

# xr-2は、10.10.6.6(SR Pfx index 6)のPrefixに対して、24004=LDPのラベルをつける
# xr-5はSRーMPLSの設定が削除され、LDPが動いているため
# 相互接続は自動でやってくれる


# xr-5を見ると、24004のLocal Labelは10.10.6.6/32に付与されていて、OutGoingの際はPopされる

RP/0/0/CPU0:XR5#show mpls forwarding
Thu Dec  8 02:33:33.877 UTC
Local  Outgoing    Prefix             Outgoing     Next Hop        Bytes
Label  Label       or ID              Interface                    Switched
------ ----------- ------------------ ------------ --------------- ------------
24000  24000       10.10.1.1/32       Gi0/0/0/0    172.16.2.2      0
24001  Pop         10.10.2.2/32       Gi0/0/0/0    172.16.2.2      1212
24002  Pop         172.16.1.0/24      Gi0/0/0/0    172.16.2.2      0
24003  24001       172.16.3.0/24      Gi0/0/0/0    172.16.2.2      0
24004  Pop         10.10.6.6/32       Gi0/0/0/1    172.16.5.6      998
24005  Pop         172.16.6.0/24      Gi0/0/0/1    172.16.5.6      0
24006  Pop         172.16.8.0/24      Gi0/0/0/1    172.16.5.6      0
24007  24002       10.10.3.3/32       Gi0/0/0/0    172.16.2.2      0
       24005       10.10.3.3/32       Gi0/0/0/1    172.16.5.6      0
24008  24006       10.10.4.4/32       Gi0/0/0/1    172.16.5.6      0
24009  24008       172.16.4.0/24      Gi0/0/0/1    172.16.5.6      0


RP/0/0/CPU0:XR1#traceroute sr-mpls multipath 10.10.6.6/32 ver
Thu Dec  8 02:45:09.289 UTC

Starting LSP Path Discovery for 10.10.6.6/32

Codes: '!' - success, 'Q' - request not sent, '.' - timeout,
  'L' - labeled output interface, 'B' - unlabeled output interface,
  'D' - DS Map mismatch, 'F' - no FEC mapping, 'f' - FEC mismatch,
  'M' - malformed request, 'm' - unsupported tlvs, 'N' - no rx label,
  'P' - no rx intf label prot, 'p' - premature termination of LSP,
  'R' - transit router, 'I' - unknown upstream index,
  'X' - unknown return code, 'x' - return code 0

Type escape sequence to abort.

LL!
Path 0 found,
 output interface GigabitEthernet0/0/0/0 nexthop 172.16.1.2
 source 172.16.1.1 destination 127.0.0.0
  0 172.16.1.1 172.16.1.2 MRU 1500 [Labels: 16006 Exp: 0] multipaths 0
L 1 172.16.1.2 172.16.2.5 MRU 1500 [Labels: 24004 Exp: 0] ret code 8 multipaths 1
L 2 172.16.2.5 172.16.5.6 MRU 1500 [Labels: implicit-null Exp: 0] ret code 8 multipaths 1
! 3 172.16.5.6, ret code 3 multipaths 0
LL!
Path 1 found,
 output interface GigabitEthernet0/0/0/1 nexthop 172.16.3.3
 source 172.16.3.1 destination 127.0.0.0
  0 172.16.3.1 172.16.3.3 MRU 1500 [Labels: 16006 Exp: 0] multipaths 0
L 1 172.16.3.3 172.16.4.4 MRU 1500 [Labels: 24006 Exp: 0] ret code 8 multipaths 1
L 2 172.16.4.4 172.16.6.6 MRU 1500 [Labels: implicit-null Exp: 0] ret code 8 multipaths 2
! 3 172.16.6.6, ret code 3 multipaths 0
...
Path 2 Unexplorable,
 output interface GigabitEthernet0/0/0/1 nexthop 172.16.3.3
 source 172.16.3.1 destination 127.0.0.1
  0 172.16.3.1 172.16.3.3 MRU 1500 [Labels: 16006 Exp: 0] multipaths 0
L 1 172.16.3.3 172.16.4.4 MRU 1500 [Labels: 24006 Exp: 0] ret code 8 multipaths 1
L 2 172.16.4.4 172.16.8.6 MRU 1500 [Labels: implicit-null Exp: 0] ret code 8 multipaths 2

Paths (found/broken/unexplored) (2/0/1)
 Echo Request (sent/fail) (9/0)
 Echo Reply (received/timeout) (6/3)
 Total Time Elapsed 5 seconds 929 ms


# xr-6からxr-1への帰りはECMPされている
RP/0/0/CPU0:XR6#show mpls forwarding
Thu Dec  8 03:49:00.228 UTC
Local  Outgoing    Prefix             Outgoing     Next Hop        Bytes
Label  Label       or ID              Interface                    Switched
------ ----------- ------------------ ------------ --------------- ------------
16001  24000       SR Pfx (idx 1)     Gi0/0/0/0    172.16.5.5      0
       24000       SR Pfx (idx 1)     Gi0/0/0/1    172.16.6.4      400
       24000       SR Pfx (idx 1)     Gi0/0/0/2    172.16.8.4      0
16002  24001       SR Pfx (idx 2)     Gi0/0/0/0    172.16.5.5      0
16003  24001       SR Pfx (idx 3)     Gi0/0/0/1    172.16.6.4      0
       24001       SR Pfx (idx 3)     Gi0/0/0/2    172.16.8.4      0
24000  24001       10.10.2.2/32       Gi0/0/0/0    172.16.5.5      0
24001  Pop         10.10.5.5/32       Gi0/0/0/0    172.16.5.5      9390
24002  24002       172.16.1.0/24      Gi0/0/0/0    172.16.5.5      80
24003  Pop         172.16.2.0/24      Gi0/0/0/0    172.16.5.5      0
24004  24000       10.10.1.1/32       Gi0/0/0/0    172.16.5.5      0
       24000       10.10.1.1/32       Gi0/0/0/1    172.16.6.4      0
       24000       10.10.1.1/32       Gi0/0/0/2    172.16.8.4      0
24005  24001       10.10.3.3/32       Gi0/0/0/1    172.16.6.4      0
       24001       10.10.3.3/32       Gi0/0/0/2    172.16.8.4      0
24006  Pop         10.10.4.4/32       Gi0/0/0/1    172.16.6.4      0
       Pop         10.10.4.4/32       Gi0/0/0/2    172.16.8.4      9506
24007  24003       172.16.3.0/24      Gi0/0/0/1    172.16.6.4      0
       24003       172.16.3.0/24      Gi0/0/0/2    172.16.8.4      80
24008  Pop         172.16.4.0/24      Gi0/0/0/1    172.16.6.4      0
       Pop         172.16.4.0/24      Gi0/0/0/2    172.16.8.4      0
24009  Pop         SR Adj (idx 0)     Gi0/0/0/0    172.16.5.5      0
24010  Pop         SR Adj (idx 0)     Gi0/0/0/1    172.16.6.4      0
24011  Pop         SR Adj (idx 0)     Gi0/0/0/2    172.16.8.4      0

 
# また、SR-MPLS Onlyのxr-1のloopback 10.10.1.1/32に対しても、SR Pfx(Idx 1)とは別にLDP用のLocal Labelを生成

RP/0/0/CPU0:XR2#show mpls forwarding
Thu Dec  8 02:35:36.549 UTC
Local  Outgoing    Prefix             Outgoing     Next Hop        Bytes
Label  Label       or ID              Interface                    Switched
------ ----------- ------------------ ------------ --------------- ------------
16001  Pop         SR Pfx (idx 1)     Gi0/0/0/0    172.16.1.1      2617
16003  16003       SR Pfx (idx 3)     Gi0/0/0/0    172.16.1.1      0
16006  24004       SR Pfx (idx 6)     Gi0/0/0/1    172.16.2.5      0
24000  Pop         10.10.1.1/32       Gi0/0/0/0    172.16.1.1      0
24001  Unlabelled  172.16.3.0/24      Gi0/0/0/0    172.16.1.1      0
24002  16003       10.10.3.3/32       Gi0/0/0/0    172.16.1.1      0
24003  Unlabelled  172.16.4.0/24      Gi0/0/0/0    172.16.1.1      0
24004  Pop         10.10.5.5/32       Gi0/0/0/1    172.16.2.5      1234
24005  Pop         172.16.5.0/24      Gi0/0/0/1    172.16.2.5      0
24006  24004       10.10.6.6/32       Gi0/0/0/1    172.16.2.5      0
24007  24005       172.16.6.0/24      Gi0/0/0/1    172.16.2.5      0
24008  24006       172.16.8.0/24      Gi0/0/0/1    172.16.2.5      0
24009  Unlabelled  10.10.4.4/32       Gi0/0/0/0    172.16.1.1      0
       24008       10.10.4.4/32       Gi0/0/0/1    172.16.2.5      0
24010  Pop         SR Adj (idx 0)     Gi0/0/0/0    172.16.1.1      0
24011  Pop         SR Adj (idx 0)     Gi0/0/0/1    172.16.2.5      0


# xr-4(LDP Only)を見ると、10.10.1.1/32へはLabel 24000をつけて出す
RP/0/0/CPU0:XR4#show mpls forwarding prefix 10.10.1.1/32
Thu Dec  8 04:22:01.411 UTC
Local  Outgoing    Prefix             Outgoing     Next Hop        Bytes
Label  Label       or ID              Interface                    Switched
------ ----------- ------------------ ------------ --------------- ------------
24000  24000       10.10.1.1/32       Gi0/0/0/0    172.16.4.3      800


# xr-3がわも同様

RP/0/0/CPU0:XR3#show mpls forwarding
Thu Dec  8 04:27:57.457 UTC
Local  Outgoing    Prefix             Outgoing     Next Hop        Bytes
Label  Label       or ID              Interface                    Switched
------ ----------- ------------------ ------------ --------------- ------------
16001  Pop         SR Pfx (idx 1)     Gi0/0/0/0    172.16.3.1      2493
16002  16002       SR Pfx (idx 2)     Gi0/0/0/0    172.16.3.1      0
16006  24006       SR Pfx (idx 6)     Gi0/0/0/1    172.16.4.4      1660
24000  Pop         10.10.1.1/32       Gi0/0/0/0    172.16.3.1      760
24001  16002       10.10.2.2/32       Gi0/0/0/0    172.16.3.1      0
24002  Unlabelled  172.16.1.0/24      Gi0/0/0/0    172.16.3.1      0
24003  Unlabelled  172.16.2.0/24      Gi0/0/0/0    172.16.3.1      0
24004  Pop         10.10.4.4/32       Gi0/0/0/1    172.16.4.4      14130
24005  Pop         172.16.6.0/24      Gi0/0/0/1    172.16.4.4      0
24006  Pop         172.16.8.0/24      Gi0/0/0/1    172.16.4.4      0
24007  Unlabelled  10.10.5.5/32       Gi0/0/0/0    172.16.3.1      0
       24005       10.10.5.5/32       Gi0/0/0/1    172.16.4.4      0
24008  24006       10.10.6.6/32       Gi0/0/0/1    172.16.4.4      0
24009  24008       172.16.5.0/24      Gi0/0/0/1    172.16.4.4      0
24010  Pop         SR Adj (idx 0)     Gi0/0/0/0    172.16.3.1      0
24011  Pop         SR Adj (idx 0)     Gi0/0/0/1    172.16.4.4      0


# が、xr-1はOnly SR-MPLSなので、xr-4,xr-5へ直接到達するLFIBは持っていない
RP/0/0/CPU0:XR1#show mpls forwarding
Thu Dec  8 04:31:08.664 UTC
Local  Outgoing    Prefix             Outgoing     Next Hop        Bytes
Label  Label       or ID              Interface                    Switched
------ ----------- ------------------ ------------ --------------- ------------
16002  Pop         SR Pfx (idx 2)     Gi0/0/0/0    172.16.1.2      2397
16003  Pop         SR Pfx (idx 3)     Gi0/0/0/1    172.16.3.3      2259
16006  16006       SR Pfx (idx 6)     Gi0/0/0/0    172.16.1.2      288
       16006       SR Pfx (idx 6)     Gi0/0/0/1    172.16.3.3      0
24010  Pop         SR Adj (idx 0)     Gi0/0/0/0    172.16.1.2      0
24011  Pop         SR Adj (idx 0)     Gi0/0/0/1    172.16.3.3      0


# そのため、xr-4へのsr-mpls pingは届かない
RP/0/0/CPU0:XR1#ping sr-mpls 10.10.4.4/32 source 10.10.1.1 verbose
Thu Dec  8 04:32:51.217 UTC

Sending 5, 100-byte MPLS Echos to 10.10.4.4/32,
      timeout is 2 seconds, send interval is 0 msec:

Codes: '!' - success, 'Q' - request not sent, '.' - timeout,
  'L' - labeled output interface, 'B' - unlabeled output interface,
  'D' - DS Map mismatch, 'F' - no FEC mapping, 'f' - FEC mismatch,
  'M' - malformed request, 'm' - unsupported tlvs, 'N' - no rx label,
  'P' - no rx intf label prot, 'p' - premature termination of LSP,
  'R' - transit router, 'I' - unknown upstream index,
  'X' - unknown return code, 'x' - return code 0

Type escape sequence to abort.

Q      size 100, Unable to send echo request packet
Q      size 100, Unable to send echo request packet
Q      size 100, Unable to send echo request packet
Q      size 100, Unable to send echo request packet
Q      size 100, Unable to send echo request packet

Success rate is 0 percent (0/5)
RP/0/0/CPU0:XR1#ping sr-mpls 10.10.6.6/32 source 10.10.1.1 verbose
Thu Dec  8 04:33:01.146 UTC

Sending 5, 100-byte MPLS Echos to 10.10.6.6/32,
      timeout is 2 seconds, send interval is 0 msec:

Codes: '!' - success, 'Q' - request not sent, '.' - timeout,
  'L' - labeled output interface, 'B' - unlabeled output interface,
  'D' - DS Map mismatch, 'F' - no FEC mapping, 'f' - FEC mismatch,
  'M' - malformed request, 'm' - unsupported tlvs, 'N' - no rx label,
  'P' - no rx intf label prot, 'p' - premature termination of LSP,
  'R' - transit router, 'I' - unknown upstream index,
  'X' - unknown return code, 'x' - return code 0

Type escape sequence to abort.

!      size 100, reply addr 172.16.6.6, return code 3
!      size 100, reply addr 172.16.6.6, return code 3
!      size 100, reply addr 172.16.6.6, return code 3
!      size 100, reply addr 172.16.6.6, return code 3
!      size 100, reply addr 172.16.6.6, return code 3

Success rate is 100 percent (5/5), round-trip min/avg/max = 10/12/20 ms






---xr-2,3にて、SR Mapping ServerをEnableにする---

# SR-Mapping Serverについては以下参照
# https://www.netone.co.jp/knowledge-center/blog-column/knowledge_takumi_204/

# LDP NWにあるNodeのLoopbackにNode SIDを付与


# xr-2を見ると、10.10.4.4/32のPrefixに、SID Index 4を, 10.10.5.5/32にIndex 5をつけて広報している

RP/0/0/CPU0:XR2#show ospf database opaque-area self-originate
Thu Dec  8 04:55:48.553 UTC


            OSPF Router with ID (10.10.2.2) (Process ID 100)

                Type-10 Opaque Link Area Link States (Area 0)

  LS age: 183
  Options: (No TOS-capability, DC)
  LS Type: Opaque Area Link
  Link State ID: 7.0.0.2
  Opaque Type: 7
  Opaque ID: 2
  Advertising Router: 10.10.2.2
  LS Seq Number: 80000001
  Checksum: 0x7ac2
  Length: 48

    Extended Prefix Range TLV: Length: 24
      AF        : 0
      Prefix    : 10.10.4.4/32
      Range Size: 1
      Flags     : 0x0

      SID sub-TLV: Length: 8
        Flags     : 0x60
        MTID      : 0
        Algo      : 0
        SID Index : 4

  LS age: 183
  Options: (No TOS-capability, DC)
  LS Type: Opaque Area Link
  Link State ID: 7.0.0.3
  Opaque Type: 7
  Opaque ID: 3
  Advertising Router: 10.10.2.2
  LS Seq Number: 80000001
  Checksum: 0xb187
  Length: 48

    Extended Prefix Range TLV: Length: 24
      AF        : 0
      Prefix    : 10.10.5.5/32
      Range Size: 1
      Flags     : 0x0

      SID sub-TLV: Length: 8
        Flags     : 0x60
        MTID      : 0
        Algo      : 0
        SID Index : 5


# xr-1のLFIBを見ると、index 4,5がそれぞれ載っている

RP/0/0/CPU0:XR1#show mpls forwarding
Thu Dec  8 05:04:13.908 UTC
Local  Outgoing    Prefix             Outgoing     Next Hop        Bytes
Label  Label       or ID              Interface                    Switched
------ ----------- ------------------ ------------ --------------- ------------
16002  Pop         SR Pfx (idx 2)     Gi0/0/0/0    172.16.1.2      2397
16003  Pop         SR Pfx (idx 3)     Gi0/0/0/1    172.16.3.3      2259
16004  16004       SR Pfx (idx 4)     Gi0/0/0/1    172.16.3.3      0
16005  16005       SR Pfx (idx 5)     Gi0/0/0/0    172.16.1.2      0
16006  16006       SR Pfx (idx 6)     Gi0/0/0/0    172.16.1.2      288
       16006       SR Pfx (idx 6)     Gi0/0/0/1    172.16.3.3      0
24010  Pop         SR Adj (idx 0)     Gi0/0/0/0    172.16.1.2      0
24011  Pop         SR Adj (idx 0)     Gi0/0/0/1    172.16.3.3      0


# sr-mpls forwarfing planeで通信可能になった
RP/0/0/CPU0:XR1#ping sr-mpls 10.10.5.5/32 so 10.10.1.1 ver
Thu Dec  8 05:06:03.690 UTC

Sending 5, 100-byte MPLS Echos to 10.10.5.5/32,
      timeout is 2 seconds, send interval is 0 msec:

Codes: '!' - success, 'Q' - request not sent, '.' - timeout,
  'L' - labeled output interface, 'B' - unlabeled output interface,
  'D' - DS Map mismatch, 'F' - no FEC mapping, 'f' - FEC mismatch,
  'M' - malformed request, 'm' - unsupported tlvs, 'N' - no rx label,
  'P' - no rx intf label prot, 'p' - premature termination of LSP,
  'R' - transit router, 'I' - unknown upstream index,
  'X' - unknown return code, 'x' - return code 0

Type escape sequence to abort.

!      size 100, reply addr 172.16.2.5, return code 3
!      size 100, reply addr 172.16.2.5, return code 3
!      size 100, reply addr 172.16.2.5, return code 3
!      size 100, reply addr 172.16.2.5, return code 3
!      size 100, reply addr 172.16.2.5, return code 3

Success rate is 100 percent (5/5), round-trip min/avg/max = 1/4/10 ms


# xr-2から見ると、xr-4(LDP only)への経路は2つ、SR-MPLSのxr-1経由か、LDPのxr-4経由

RP/0/0/CPU0:XR2#show mpls forwarding
Thu Dec  8 05:11:37.718 UTC
Local  Outgoing    Prefix             Outgoing     Next Hop        Bytes
Label  Label       or ID              Interface                    Switched
------ ----------- ------------------ ------------ --------------- ------------
16001  Pop         SR Pfx (idx 1)     Gi0/0/0/0    172.16.1.1      2617
16003  16003       SR Pfx (idx 3)     Gi0/0/0/0    172.16.1.1      0
16004  16004       SR Pfx (idx 4)     Gi0/0/0/0    172.16.1.1      0
       24008       SR Pfx (idx 4)     Gi0/0/0/1    172.16.2.5      0
16005  Pop         SR Pfx (idx 5)     Gi0/0/0/1    172.16.2.5      3038
16006  24004       SR Pfx (idx 6)     Gi0/0/0/1    172.16.2.5      264
24000  Pop         10.10.1.1/32       Gi0/0/0/0    172.16.1.1      1520
24001  Unlabelled  172.16.3.0/24      Gi0/0/0/0    172.16.1.1      0
24002  16003       10.10.3.3/32       Gi0/0/0/0    172.16.1.1      0
24003  Unlabelled  172.16.4.0/24      Gi0/0/0/0    172.16.1.1      0
24004  Pop         10.10.5.5/32       Gi0/0/0/1    172.16.2.5      1038
24005  Pop         172.16.5.0/24      Gi0/0/0/1    172.16.2.5      0
24006  24004       10.10.6.6/32       Gi0/0/0/1    172.16.2.5      0
24007  24005       172.16.6.0/24      Gi0/0/0/1    172.16.2.5      0
24008  24006       172.16.8.0/24      Gi0/0/0/1    172.16.2.5      0
24009  16004       10.10.4.4/32       Gi0/0/0/0    172.16.1.1      0
       24008       10.10.4.4/32       Gi0/0/0/1    172.16.2.5      0
24010  Pop         SR Adj (idx 0)     Gi0/0/0/0    172.16.1.1      0
24011  Pop         SR Adj (idx 0)     Gi0/0/0/1    172.16.2.5      0



# xr-2からxr-4への経路は、LDP MPLSならxr-5へ、SR-MPLSならxr-1へ行く

RP/0/0/CPU0:XR2#traceroute mpls multipath ipv4 10.10.4.4/32 source 10.10.2.2 ver
Thu Dec  8 05:14:25.796 UTC

Starting LSP Path Discovery for 10.10.4.4/32

Codes: '!' - success, 'Q' - request not sent, '.' - timeout,
  'L' - labeled output interface, 'B' - unlabeled output interface,
  'D' - DS Map mismatch, 'F' - no FEC mapping, 'f' - FEC mismatch,
  'M' - malformed request, 'm' - unsupported tlvs, 'N' - no rx label,
  'P' - no rx intf label prot, 'p' - premature termination of LSP,
  'R' - transit router, 'I' - unknown upstream index,
  'X' - unknown return code, 'x' - return code 0

Type escape sequence to abort.

LB
Path 0 Broken,
 output interface GigabitEthernet0/0/0/0 nexthop 172.16.1.1
 source 10.10.2.2 destination 127.0.0.0
  0 10.10.2.2 172.16.1.1 MRU 1500 [Labels: 16004 Exp: 0] multipaths 0
L 1 172.16.1.1 172.16.3.3 MRU 1500 [Labels: 16004 Exp: 0] ret code 8 multipaths 1
B 2 172.16.3.3 172.16.4.4 MRU 1500 [No Label], ret code 9 multipaths 1
LL!
Path 1 found,
 output interface GigabitEthernet0/0/0/1 nexthop 172.16.2.5
 source 10.10.2.2 destination 127.0.0.0
  0 10.10.2.2 172.16.2.5 MRU 1500 [Labels: 24008 Exp: 0] multipaths 0
L 1 172.16.2.5 172.16.5.6 MRU 1500 [Labels: 24006 Exp: 0] ret code 8 multipaths 1
L 2 172.16.5.6 172.16.6.4 MRU 1500 [Labels: implicit-null Exp: 0] ret code 8 multipaths 2
! 3 172.16.6.4, ret code 3 multipaths 0
...
Path 2 Unexplorable,
 output interface GigabitEthernet0/0/0/1 nexthop 172.16.2.5
 source 10.10.2.2 destination 127.0.0.1
  0 10.10.2.2 172.16.2.5 MRU 1500 [Labels: 24008 Exp: 0] multipaths 0
L 1 172.16.2.5 172.16.5.6 MRU 1500 [Labels: 24006 Exp: 0] ret code 8 multipaths 1
L 2 172.16.5.6 172.16.8.4 MRU 1500 [Labels: implicit-null Exp: 0] ret code 8 multipaths 2

Paths (found/broken/unexplored) (1/1/1)
 Echo Request (sent/fail) (8/0)
 Echo Reply (received/timeout) (5/3)
 Total Time Elapsed 5 seconds 689 ms


RP/0/0/CPU0:XR2#traceroute sr-mpls multipath 10.10.4.4/32 source 10.10.2.2 ver
Thu Dec  8 05:15:19.052 UTC

Starting LSP Path Discovery for 10.10.4.4/32

Codes: '!' - success, 'Q' - request not sent, '.' - timeout,
  'L' - labeled output interface, 'B' - unlabeled output interface,
  'D' - DS Map mismatch, 'F' - no FEC mapping, 'f' - FEC mismatch,
  'M' - malformed request, 'm' - unsupported tlvs, 'N' - no rx label,
  'P' - no rx intf label prot, 'p' - premature termination of LSP,
  'R' - transit router, 'I' - unknown upstream index,
  'X' - unknown return code, 'x' - return code 0

Type escape sequence to abort.

LL!
Path 0 found,
 output interface GigabitEthernet0/0/0/0 nexthop 172.16.1.1
 source 10.10.2.2 destination 127.0.0.0
  0 10.10.2.2 172.16.1.1 MRU 1500 [Labels: 16004 Exp: 0] multipaths 0
L 1 172.16.1.1 172.16.3.3 MRU 1500 [Labels: 16004 Exp: 0] ret code 8 multipaths 1
L 2 172.16.3.3 172.16.4.4 MRU 1500 [Labels: implicit-null Exp: 0] ret code 8 multipaths 1
! 3 172.16.4.4, ret code 3 multipaths 0

Paths (found/broken/unexplored) (1/0/0)
 Echo Request (sent/fail) (3/0)
 Echo Reply (received/timeout) (3/0)
 Total Time Elapsed 49 ms


---SR-MPLS Onlyで構築する---

# xr-2,3からSRMSの設定を削除する
# xr-4,xr-5でSR-MPLSをenableにする
# ldp設定をxr-2,3,4,5,6から削除する
# xr-1からはLDPはすでに削除されている



# xr-1で、各Node SIDと自分のAdj SIDがLFIBテーブルにのる
RP/0/0/CPU0:XR1#show mpls forwarding
Thu Dec  8 05:27:14.363 UTC
Local  Outgoing    Prefix             Outgoing     Next Hop        Bytes
Label  Label       or ID              Interface                    Switched
------ ----------- ------------------ ------------ --------------- ------------
16002  Pop         SR Pfx (idx 2)     Gi0/0/0/0    172.16.1.2      2833
16003  Pop         SR Pfx (idx 3)     Gi0/0/0/1    172.16.3.3      2259
16004  16004       SR Pfx (idx 4)     Gi0/0/0/1    172.16.3.3      0
16005  16005       SR Pfx (idx 5)     Gi0/0/0/0    172.16.1.2      0
16006  16006       SR Pfx (idx 6)     Gi0/0/0/0    172.16.1.2      288
       16006       SR Pfx (idx 6)     Gi0/0/0/1    172.16.3.3      0
24010  Pop         SR Adj (idx 0)     Gi0/0/0/0    172.16.1.2      0
24011  Pop         SR Adj (idx 0)     Gi0/0/0/1    172.16.3.3      0


# Adj SIDは自動計算され、対抗Node同士は同じLocal LabelでのAdj SIDとなる
# Adj SIDはNodeにLocalなので、隣接していないNodeの他のAdj SIDと同じLocal Labelが使われることは当然ある

RP/0/0/CPU0:XR2#show mpls forwarding
Thu Dec  8 05:34:21.394 UTC
Local  Outgoing    Prefix             Outgoing     Next Hop        Bytes
Label  Label       or ID              Interface                    Switched
------ ----------- ------------------ ------------ --------------- ------------
16001  Pop         SR Pfx (idx 1)     Gi0/0/0/0    172.16.1.1      2617
16003  16003       SR Pfx (idx 3)     Gi0/0/0/0    172.16.1.1      0
16004  16004       SR Pfx (idx 4)     Gi0/0/0/0    172.16.1.1      0
       16004       SR Pfx (idx 4)     Gi0/0/0/1    172.16.2.5      0
16005  Pop         SR Pfx (idx 5)     Gi0/0/0/1    172.16.2.5      0
16006  16006       SR Pfx (idx 6)     Gi0/0/0/1    172.16.2.5      0
24010  Pop         SR Adj (idx 0)     Gi0/0/0/0    172.16.1.1      0
24011  Pop         SR Adj (idx 0)     Gi0/0/0/1    172.16.2.5      0

RP/0/0/CPU0:XR5#show mpls forwarding
Thu Dec  8 05:34:49.852 UTC
Local  Outgoing    Prefix             Outgoing     Next Hop        Bytes
Label  Label       or ID              Interface                    Switched
------ ----------- ------------------ ------------ --------------- ------------
16001  16001       SR Pfx (idx 1)     Gi0/0/0/0    172.16.2.2      0
16002  Pop         SR Pfx (idx 2)     Gi0/0/0/0    172.16.2.2      0
16003  16003       SR Pfx (idx 3)     Gi0/0/0/0    172.16.2.2      0
       16003       SR Pfx (idx 3)     Gi0/0/0/1    172.16.5.6      0
16004  16004       SR Pfx (idx 4)     Gi0/0/0/1    172.16.5.6      0
16006  Pop         SR Pfx (idx 6)     Gi0/0/0/1    172.16.5.6      80
24010  Pop         SR Adj (idx 0)     Gi0/0/0/0    172.16.2.2      0
24011  Pop         SR Adj (idx 0)     Gi0/0/0/1    172.16.5.6      0


RP/0/0/CPU0:XR1#traceroute 10.10.6.6
Thu Dec  8 05:37:10.312 UTC

Type escape sequence to abort.
Tracing the route to 10.10.6.6

 1  172.16.3.3 [MPLS: Label 16006 Exp 0] 19 msec  9 msec  0 msec
 2  172.16.4.4 [MPLS: Label 16006 Exp 0] 9 msec  0 msec  0 msec
 3  172.16.6.6 0 msec  *  0 msec


RP/0/0/CPU0:XR1#traceroute sr-mpls 10.10.6.6/32 source 10.10.1.1 verbose
Thu Dec  8 05:37:50.870 UTC

Tracing MPLS Label Switched Path to 10.10.6.6/32, timeout is 2 seconds

Codes: '!' - success, 'Q' - request not sent, '.' - timeout,
  'L' - labeled output interface, 'B' - unlabeled output interface,
  'D' - DS Map mismatch, 'F' - no FEC mapping, 'f' - FEC mismatch,
  'M' - malformed request, 'm' - unsupported tlvs, 'N' - no rx label,
  'P' - no rx intf label prot, 'p' - premature termination of LSP,
  'R' - transit router, 'I' - unknown upstream index,
  'X' - unknown return code, 'x' - return code 0

Type escape sequence to abort.

  0 172.16.3.1 172.16.3.3 MRU 1500 [Labels: 16006 Exp: 0]
L 1 172.16.3.3 172.16.4.4 MRU 1500 [Labels: 16006 Exp: 0] 0 ms, ret code 8
L 2 172.16.4.4 172.16.6.6 MRU 1500 [Labels: implicit-null Exp: 0] 10 ms, ret code 8
! 3 172.16.6.6 10 ms, ret code 3




---TI-LFAの設定---

# TI-LFAの設定

# PrefixごとのBackUpパスをIGP(OSPFが)事前に計算している
# TI-FLA でのPQ Node=BackUp Path利用時にループしないよう最も近いNodeまでSRーMPLSでラベルスイッチングする必要がある。詳しくは↓
# https://www.netone.co.jp/knowledge-center/blog-column/knowledge_takumi_121/

router ospf 100
 area 0
  fast-reroute per-prefix
  fast-reroute per-prefix ti-lfa enable



RP/0/0/CPU0:XR1#show ospf neighbor detail
Thu Dec  8 05:59:28.251 UTC

* Indicates MADJ interface
# Indicates Neighbor awaiting BFD session up

Neighbors for OSPF 100

 Neighbor 10.10.2.2, interface address 172.16.1.2
    In the area 0 via interface GigabitEthernet0/0/0/0
    Neighbor priority is 1, State is FULL, 6 state changes
    DR is 0.0.0.0 BDR is 0.0.0.0
    Options is 0x52
    LLS Options is 0x1 (LR)
    Dead timer due in 00:00:37
    Neighbor is up for 05:48:53
    Number of DBD retrans during last exchange 0
    Index 1/1, retransmission queue length 0, number of retransmission 5
    First 0(0)/0(0) Next 0(0)/0(0)
    Last retransmission scan length is 3, maximum is 3
    Last retransmission scan time is 0 msec, maximum is 0 msec
    LS Ack list: NSR-sync pending 0, high water mark 0
    # Adjacency SIDがprotectedインある
    Adjacency SID Label: 24000, Protected
    Unprotected Adjacency SID Label: 24010
    Neighbor Interface ID: 4

 Neighbor 10.10.3.3, interface address 172.16.3.3
    In the area 0 via interface GigabitEthernet0/0/0/1
    Neighbor priority is 1, State is FULL, 6 state changes
    DR is 0.0.0.0 BDR is 0.0.0.0
    Options is 0x52
    LLS Options is 0x1 (LR)
    Dead timer due in 00:00:37
    Neighbor is up for 05:48:53
    Number of DBD retrans during last exchange 0
    Index 2/2, retransmission queue length 0, number of retransmission 6
    First 0(0)/0(0) Next 0(0)/0(0)
    Last retransmission scan length is 2, maximum is 2
    Last retransmission scan time is 0 msec, maximum is 0 msec
    LS Ack list: NSR-sync pending 0, high water mark 0
    Adjacency SID Label: 24001, Protected
    Unprotected Adjacency SID Label: 24011
    Neighbor Interface ID: 4


Total neighbor count: 2


# RIB上で、BackUp Pathが計算されている
RP/0/0/CPU0:XR1#show route
Thu Dec  8 06:00:58.345 UTC

Codes: C - connected, S - static, R - RIP, B - BGP, (>) - Diversion path
       D - EIGRP, EX - EIGRP external, O - OSPF, IA - OSPF inter area
       N1 - OSPF NSSA external type 1, N2 - OSPF NSSA external type 2
       E1 - OSPF external type 1, E2 - OSPF external type 2, E - EGP
       i - ISIS, L1 - IS-IS level-1, L2 - IS-IS level-2
       ia - IS-IS inter area, su - IS-IS summary null, * - candidate default
       U - per-user static route, o - ODR, L - local, G  - DAGR, l - LISP
       A - access/subscriber, a - Application route
       M - mobile route, r - RPL, t - Traffic Engineering, (!) - FRR Backup path

Gateway of last resort is not set

L    10.10.1.1/32 is directly connected, 05:50:33, Loopback0
O    10.10.2.2/32 [110/2] via 172.16.1.2, 00:09:02, GigabitEthernet0/0/0/0
                  [110/6] via 172.16.3.3, 00:09:02, GigabitEthernet0/0/0/1 (!)
O    10.10.3.3/32 [110/6] via 172.16.1.2, 00:09:02, GigabitEthernet0/0/0/0 (!)
                  [110/2] via 172.16.3.3, 00:09:02, GigabitEthernet0/0/0/1
O    10.10.4.4/32 [110/5] via 172.16.1.2, 00:09:02, GigabitEthernet0/0/0/0 (!)
                  [110/3] via 172.16.3.3, 00:09:02, GigabitEthernet0/0/0/1
O    10.10.5.5/32 [110/3] via 172.16.1.2, 00:09:02, GigabitEthernet0/0/0/0
                  [110/5] via 172.16.3.3, 00:09:02, GigabitEthernet0/0/0/1 (!)
O    10.10.6.6/32 [110/4] via 172.16.1.2, 00:08:23, GigabitEthernet0/0/0/0
                  [110/4] via 172.16.3.3, 00:08:23, GigabitEthernet0/0/0/1
L    127.0.0.0/8 [0/0] via 0.0.0.0, 04:44:55
C    172.16.1.0/24 is directly connected, 05:50:33, GigabitEthernet0/0/0/0
L    172.16.1.1/32 is directly connected, 05:50:33, GigabitEthernet0/0/0/0
O    172.16.2.0/24 [110/2] via 172.16.1.2, 00:09:02, GigabitEthernet0/0/0/0
                   [110/5] via 172.16.3.3, 00:09:02, GigabitEthernet0/0/0/1 (!)
C    172.16.3.0/24 is directly connected, 05:50:33, GigabitEthernet0/0/0/1
L    172.16.3.1/32 is directly connected, 05:50:33, GigabitEthernet0/0/0/1
O    172.16.4.0/24 [110/5] via 172.16.1.2, 00:09:02, GigabitEthernet0/0/0/0 (!)
                   [110/2] via 172.16.3.3, 00:09:02, GigabitEthernet0/0/0/1
O    172.16.5.0/24 [110/3] via 172.16.1.2, 00:08:23, GigabitEthernet0/0/0/0
                   [110/4] via 172.16.3.3, 00:08:23, GigabitEthernet0/0/0/1 (!)
O    172.16.6.0/24 [110/4] via 172.16.1.2, 00:08:23, GigabitEthernet0/0/0/0 (!)
                   [110/3] via 172.16.3.3, 00:08:23, GigabitEthernet0/0/0/1
O    172.16.8.0/24 [110/4] via 172.16.1.2, 00:08:23, GigabitEthernet0/0/0/0 (!)
                   [110/3] via 172.16.3.3, 00:08:23, GigabitEthernet0/0/0/1

RP/0/0/CPU0:XR1#show route 10.10.2.2
Thu Dec  8 06:21:43.589 UTC

Routing entry for 10.10.2.2/32
  Known via "ospf 100", distance 110, metric 2, labeled SR, type intra area
  Installed Dec  8 05:51:56.402 for 00:29:47
  Routing Descriptor Blocks
    172.16.1.2, from 10.10.2.2, via GigabitEthernet0/0/0/0, Protected
      Route metric is 2
    172.16.3.3, from 10.10.2.2, via GigabitEthernet0/0/0/1, Backup (TI-LFA)
      Repair Node(s): 10.10.6.6
      Route metric is 6
  No advertising protos.


# cefを見ると、labelは16006, 16002 一旦xr-6に行ったのちに160002へ到達する 
RP/0/0/CPU0:XR1#show cef 10.10.2.2
Thu Dec  8 06:22:50.795 UTC
10.10.2.2/32, version 65, labeled SR, internal 0x1000001 0x83 (ptr 0xa13fbeb4) [1], 0x0 (0xa13de490), 0xa28 (0xa19dd088)
 Updated Dec  8 05:51:56.432
 local adjacency 172.16.1.2
 Prefix Len 32, traffic index 0, precedence n/a, priority 1
   via 172.16.1.2/32, GigabitEthernet0/0/0/0, 10 dependencies, weight 0, class 0, protected [flags 0x400]
    path-idx 0 bkup-idx 1 NHID 0x0 [0xa1900330 0xa1900210]
    next hop 172.16.1.2/32
     local label 16002      labels imposed {ImplNull}
   via 172.16.3.3/32, GigabitEthernet0/0/0/1, 10 dependencies, weight 0, class 0, backup (TI-LFA) [flags 0xb00]
    path-idx 1 NHID 0x0 [0xa189b530 0x0]
    next hop 172.16.3.3/32, Repair Node(s): 10.10.6.6
    local adjacency
     local label 16002      labels imposed {16006 16002}


# xr-5でも同様一旦xr-6へ到達する
RP/0/0/CPU0:XR1#show cef 10.10.5.5
Thu Dec  8 06:24:10.229 UTC
10.10.5.5/32, version 71, labeled SR, internal 0x1000001 0x83 (ptr 0xa13fc0e4) [1], 0x0 (0xa13de990), 0xa28 (0xa19dd178)
 Updated Dec  8 05:51:56.441
 local adjacency 172.16.1.2
 Prefix Len 32, traffic index 0, precedence n/a, priority 1
   via 172.16.1.2/32, GigabitEthernet0/0/0/0, 10 dependencies, weight 0, class 0, protected [flags 0x400]
    path-idx 0 bkup-idx 1 NHID 0x0 [0xa1900210 0x0]
    next hop 172.16.1.2/32
     local label 16005      labels imposed {16005}
   via 172.16.3.3/32, GigabitEthernet0/0/0/1, 10 dependencies, weight 0, class 0, backup (TI-LFA) [flags 0xb00]
    path-idx 1 NHID 0x0 [0xa189b530 0x0]
    next hop 172.16.3.3/32, Repair Node(s): 10.10.6.6
    local adjacency
     local label 16005      labels imposed {16006 16005}


# PQ-Nodeとしてxr-6が選定されているため、xr-6までラベルスイッチングされる

RP/0/0/CPU0:XR1#show ospf routes backup-path
Thu Dec  8 06:25:14.675 UTC

Topology Table for ospf 100 with ID 10.10.1.1

Codes: O - Intra area, O IA - Inter area
       O E1 - External type 1, O E2 - External type 2
       O N1 - NSSA external type 1, O N2 - NSSA external type 2

O    10.10.1.1/32, metric 1
       10.10.1.1, directly connected, via Loopback0
O    10.10.2.2/32, metric 2
       172.16.1.2, from 10.10.2.2, via GigabitEthernet0/0/0/0, path-id 1
           Backup path: TI-LFA, Repair-List: P node: 10.10.6.6       Label: 16006
              172.16.3.3, from 10.10.2.2, via GigabitEthernet0/0/0/1, protected bitmap 0000000000000001
              Attributes: Metric: 6, Interface Disjoint, SRLG Disjoint
O    10.10.3.3/32, metric 2
       172.16.3.3, from 10.10.3.3, via GigabitEthernet0/0/0/1, path-id 1
           Backup path: TI-LFA, Repair-List: P node: 10.10.6.6       Label: 16006
              172.16.1.2, from 10.10.3.3, via GigabitEthernet0/0/0/0, protected bitmap 0000000000000001
              Attributes: Metric: 6, Interface Disjoint, SRLG Disjoint
O    10.10.4.4/32, metric 3
       172.16.3.3, from 10.10.4.4, via GigabitEthernet0/0/0/1, path-id 1
           Backup path: TI-LFA, Repair-List: P node: 10.10.6.6       Label: 16006
              172.16.1.2, from 10.10.4.4, via GigabitEthernet0/0/0/0, protected bitmap 0000000000000001
              Attributes: Metric: 5, Interface Disjoint, SRLG Disjoint
O    10.10.5.5/32, metric 3
       172.16.1.2, from 10.10.5.5, via GigabitEthernet0/0/0/0, path-id 1
           Backup path: TI-LFA, Repair-List: P node: 10.10.6.6       Label: 16006
              172.16.3.3, from 10.10.5.5, via GigabitEthernet0/0/0/1, protected bitmap 0000000000000001
              Attributes: Metric: 5, Interface Disjoint, SRLG Disjoint


#xr-1-2間のAdj SID(local label 24000)も、16000経由のBackUp Pathが計算されている

RP/0/0/CPU0:XR1#show mpls forwarding
Thu Dec  8 06:53:49.607 UTC
Local  Outgoing    Prefix             Outgoing     Next Hop        Bytes
Label  Label       or ID              Interface                    Switched
------ ----------- ------------------ ------------ --------------- ------------
16002  Pop         SR Pfx (idx 2)     Gi0/0/0/0    172.16.1.2      0
       16006       SR Pfx (idx 2)     Gi0/0/0/1    172.16.3.3      0            (!)
16003  Pop         SR Pfx (idx 3)     Gi0/0/0/1    172.16.3.3      0
       16006       SR Pfx (idx 3)     Gi0/0/0/0    172.16.1.2      0            (!)
16004  16004       SR Pfx (idx 4)     Gi0/0/0/1    172.16.3.3      0
       16006       SR Pfx (idx 4)     Gi0/0/0/0    172.16.1.2      0            (!)
16005  16005       SR Pfx (idx 5)     Gi0/0/0/0    172.16.1.2      0
       16006       SR Pfx (idx 5)     Gi0/0/0/1    172.16.3.3      0            (!)
16006  16006       SR Pfx (idx 6)     Gi0/0/0/0    172.16.1.2      0
       16006       SR Pfx (idx 6)     Gi0/0/0/1    172.16.3.3      0
24000  Pop         SR Adj (idx 0)     Gi0/0/0/0    172.16.1.2      0
       16006       SR Adj (idx 0)     Gi0/0/0/1    172.16.3.3      0            (!)
24001  Pop         SR Adj (idx 0)     Gi0/0/0/1    172.16.3.3      0
       16006       SR Adj (idx 0)     Gi0/0/0/0    172.16.1.2      0            (!)
24010  Pop         SR Adj (idx 0)     Gi0/0/0/0    172.16.1.2      0


RP/0/0/CPU0:XR1#show mpls forwarding labels 24000 detail
Thu Dec  8 06:47:15.314 UTC
Local  Outgoing    Prefix             Outgoing     Next Hop        Bytes
Label  Label       or ID              Interface                    Switched
------ ----------- ------------------ ------------ --------------- ------------
24000  Pop         SR Adj (idx 0)     Gi0/0/0/0    172.16.1.2      0
     Updated: Dec  8 05:51:56.431
     Path Flags: 0x400 [  BKUP-IDX:1 (0xa1900330) ]
     Version: 57, Priority: 1
     Label Stack (Top -> Bottom): { Imp-Null }
     NHID: 0x0, Encap-ID: N/A, Path idx: 0, Backup path idx: 1, Weight: 1
     MAC/Encaps: 14/14, MTU: 1500
     Outgoing Interface: GigabitEthernet0/0/0/0 (ifhandle 0x00000040)
     Packets Switched: 0

       16006       SR Adj (idx 0)     Gi0/0/0/1    172.16.3.3      0            (!)
     Updated: Dec  8 05:51:56.431
     Path Flags: 0x100 [  BKUP, NoFwd ]
     Version: 57, Priority: 1
     Label Stack (Top -> Bottom): { 16006 16002 }
     NHID: 0x0, Encap-ID: N/A, Path idx: 1, Backup path idx: 0, Weight: 6
     MAC/Encaps: 14/22, MTU: 1500
     Outgoing Interface: GigabitEthernet0/0/0/1 (ifhandle 0x00000060)
     Packets Switched: 0
     (!): FRR pure backup


---SR TE---
# Adj SID固定で振られていないの不便じゃね？どうやって使うん？

# https://y-network.jp/2020/07/22/segment-routing-018/

# xr-1,2,3,4,5,6でSR-TEをEnableにする

router ospf 100
 distribute link-state
 mpls traffic-eng router-id loopback 0
 area 0
  mpls traffic-eng

router ospf 100
# OSPFのLink State情報を他のサービス(SR-TE)で使えるようにする
 distribute link-state
# SR-TEにLoopback 0を使う
 mpls traffic-eng router-id loopback 0
 area 0
# SR-TEをEnableにする
  mpls traffic-engr



# Node SIDとAdj-SIDがSR-TEのDBに乗る

RP/0/0/CPU0:XR1#show segment-routing traffic-eng ipv4 topology
Fri Dec  9 05:34:40.009 UTC

SR-TE topology database
-----------------------

Node 1
  TE router ID: 10.10.1.1
  OSPF router ID: 10.10.1.1 area ID: 0
  Prefix SID:
    Prefix 10.10.1.1, label 16001 (regular)

  Link[0]: local address 172.16.1.1, remote address 172.16.1.2
    Local node:
      OSPF router ID: 10.10.1.1 area ID: 0
    Remote node:
      TE router ID: 10.10.2.2
      OSPF router ID: 10.10.2.2 area ID: 0
    Metric: IGP 1, TE 1
    Bandwidth: Total link 125000000, Reservable 0
    Admin-groups: 0x00000000
    Adj SID: 24012 (protected) 24010 (unprotected)

  Link[1]: local address 172.16.3.1, remote address 172.16.3.3
    Local node:
      OSPF router ID: 10.10.1.1 area ID: 0
    Remote node:
      TE router ID: 10.10.3.3
      OSPF router ID: 10.10.3.3 area ID: 0
    Metric: IGP 1, TE 1
    Bandwidth: Total link 125000000, Reservable 0
    Admin-groups: 0x00000000
    Adj SID: 24013 (protected) 24011 (unprotected)

Node 2
  TE router ID: 10.10.2.2
  OSPF router ID: 10.10.2.2 area ID: 0
  Prefix SID:
    Prefix 10.10.2.2, label 16002 (regular)

  Link[0]: local address 172.16.1.2, remote address 172.16.1.1
    Local node:
      OSPF router ID: 10.10.2.2 area ID: 0
    Remote node:
      TE router ID: 10.10.1.1
      OSPF router ID: 10.10.1.1 area ID: 0
    Metric: IGP 1, TE 1
    Bandwidth: Total link 125000000, Reservable 0
    Admin-groups: 0x00000000
    Adj SID: 24012 (protected) 24010 (unprotected)

  Link[1]: local address 172.16.2.2, remote address 172.16.2.5
    Local node:
      OSPF router ID: 10.10.2.2 area ID: 0
    Remote node:
      TE router ID: 10.10.5.5
      OSPF router ID: 10.10.5.5 area ID: 0
    Metric: IGP 1, TE 1
    Bandwidth: Total link 125000000, Reservable 0
    Admin-groups: 0x00000000
    Adj SID: 24013 (protected) 24011 (unprotected)

Node 3
  TE router ID: 10.10.3.3
  OSPF router ID: 10.10.3.3 area ID: 0
  Prefix SID:
    Prefix 10.10.3.3, label 16003 (regular)

  Link[0]: local address 172.16.3.3, remote address 172.16.3.1
    Local node:
      OSPF router ID: 10.10.3.3 area ID: 0
    Remote node:
      TE router ID: 10.10.1.1
      OSPF router ID: 10.10.1.1 area ID: 0
    Metric: IGP 1, TE 1
    Bandwidth: Total link 125000000, Reservable 0
    Admin-groups: 0x00000000
    Adj SID: 24012 (protected) 24010 (unprotected)

  Link[1]: local address 172.16.4.3, remote address 172.16.4.4
    Local node:
      OSPF router ID: 10.10.3.3 area ID: 0
    Remote node:
      TE router ID: 10.10.4.4
      OSPF router ID: 10.10.4.4 area ID: 0
    Metric: IGP 1, TE 1
    Bandwidth: Total link 125000000, Reservable 0
    Admin-groups: 0x00000000
    Adj SID: 24013 (protected) 24011 (unprotected)

Node 4
  TE router ID: 10.10.5.5
  OSPF router ID: 10.10.5.5 area ID: 0
  Prefix SID:
    Prefix 10.10.5.5, label 16005 (regular)

  Link[0]: local address 172.16.2.5, remote address 172.16.2.2
    Local node:
      OSPF router ID: 10.10.5.5 area ID: 0
    Remote node:
      TE router ID: 10.10.2.2
      OSPF router ID: 10.10.2.2 area ID: 0
    Metric: IGP 1, TE 1
    Bandwidth: Total link 125000000, Reservable 0
    Admin-groups: 0x00000000
    Adj SID: 24012 (protected) 24010 (unprotected)

  Link[1]: local address 172.16.5.5, remote address 172.16.5.6
    Local node:
      OSPF router ID: 10.10.5.5 area ID: 0
    Remote node:
      TE router ID: 10.10.6.6
      OSPF router ID: 10.10.6.6 area ID: 0
    Metric: IGP 1, TE 1
    Bandwidth: Total link 125000000, Reservable 0
    Admin-groups: 0x00000000
    Adj SID: 24013 (protected) 24011 (unprotected)

Node 5
  TE router ID: 10.10.4.4
  OSPF router ID: 10.10.4.4 area ID: 0
  Prefix SID:
    Prefix 10.10.4.4, label 16004 (regular)

  Link[0]: local address 172.16.4.4, remote address 172.16.4.3
    Local node:
      OSPF router ID: 10.10.4.4 area ID: 0
    Remote node:
      TE router ID: 10.10.3.3
      OSPF router ID: 10.10.3.3 area ID: 0
    Metric: IGP 1, TE 1
    Bandwidth: Total link 125000000, Reservable 0
    Admin-groups: 0x00000000
    Adj SID: 24012 (protected) 24009 (unprotected)

  Link[1]: local address 172.16.6.4, remote address 172.16.6.6
    Local node:
      OSPF router ID: 10.10.4.4 area ID: 0
    Remote node:
      TE router ID: 10.10.6.6
      OSPF router ID: 10.10.6.6 area ID: 0
    Metric: IGP 1, TE 1
    Bandwidth: Total link 125000000, Reservable 0
    Admin-groups: 0x00000000
    Adj SID: 24013 (protected) 24010 (unprotected)

  Link[2]: local address 172.16.8.4, remote address 172.16.8.6
    Local node:
      OSPF router ID: 10.10.4.4 area ID: 0
    Remote node:
      TE router ID: 10.10.6.6
      OSPF router ID: 10.10.6.6 area ID: 0
    Metric: IGP 1, TE 1
    Bandwidth: Total link 125000000, Reservable 0
    Admin-groups: 0x00000000
    Adj SID: 24014 (protected) 24011 (unprotected)

Node 6
  TE router ID: 10.10.6.6
  OSPF router ID: 10.10.6.6 area ID: 0
  Prefix SID:
    Prefix 10.10.6.6, label 16006 (regular)

  Link[0]: local address 172.16.6.6, remote address 172.16.6.4
    Local node:
      OSPF router ID: 10.10.6.6 area ID: 0
    Remote node:
      TE router ID: 10.10.4.4
      OSPF router ID: 10.10.4.4 area ID: 0
    Metric: IGP 1, TE 1
    Bandwidth: Total link 125000000, Reservable 0
    Admin-groups: 0x00000000
    Adj SID: 24013 (protected) 24010 (unprotected)

  Link[1]: local address 172.16.8.6, remote address 172.16.8.4
    Local node:
      OSPF router ID: 10.10.6.6 area ID: 0
    Remote node:
      TE router ID: 10.10.4.4
      OSPF router ID: 10.10.4.4 area ID: 0
    Metric: IGP 1, TE 1
    Bandwidth: Total link 125000000, Reservable 0
    Admin-groups: 0x00000000
    Adj SID: 24014 (protected) 24011 (unprotected)

  Link[2]: local address 172.16.5.6, remote address 172.16.5.5
    Local node:
      OSPF router ID: 10.10.6.6 area ID: 0
    Remote node:
      TE router ID: 10.10.5.5
      OSPF router ID: 10.10.5.5 area ID: 0
    Metric: IGP 1, TE 1
    Bandwidth: Total link 125000000, Reservable 0
    Admin-groups: 0x00000000
    Adj SID: 24012 (protected) 24009 (unprotected)



# Explicit Pathを書く
# colorはHeadーEndとEnd Pointが同じSR-TE Policyを識別するための識別し
# candidate-pathsとは？

# https://y-network.jp/2020/07/22/segment-routing-018/

segment-routing
  traffic-eng
    segment-list XR1-ASA-XR6
      # SID指定でもいける
      index 10 address ipv4 10.10.3.3
      index 20 address ipv4 10.10.4.4
      index 30 address ipv4 10.10.6.6
    !
    policy XR-1-to-XR6
      # end-pointでSR-MPLSの終点を指定
      color 100 end-point ipv4 10.10.6.6
      !
      candidate-paths
      # PrefernceでCandidate-Pathの優先度を設定する
        prefernce 100
          explicit segment-list XR1-ASA-XR6
          !
        !
      !
    !
  !
!

  
RP/0/0/CPU0:XR1#show segment-routing traffic-eng policy detail
Wed Dec 21 04:01:51.853 UTC

SR-TE policy database
---------------------

Color: 100, End-point: 10.10.6.6
  Name: srte_c_100_ep_10.10.6.6
  Status:
    Admin: up  Operational: up for 00:00:27 (since Dec 21 04:01:24.755)
  Candidate-paths:
    Preference: 100 (configuration) (current)
      Name: XR1-to-XR6
      Requested BSID: dynamic
      Explicit: segment-list XR1-ASA-XR6 (valid)
        Weight: 1, Metric Type: TE
          16003 [Prefix-SID, 10.10.3.3]
          16004 [Prefix-SID, 10.10.4.4]
          16006 [Prefix-SID, 10.10.6.6]
  LSPs:
    LSP[0]:
      LSP-ID: 1 policy ID: 1 (current)
      Local label: 24000
      State: Programmed
      Binding SID: 24001
  Attributes:
    Binding SID: 24001
    Forward Class: 0
    Steering BGP disabled: no
    IPv6 caps enable: yes


# この時点では、SR-TE PolicyはEnableではあるが、実際には使われていない

RP/0/0/CPU0:XR1#show cef 10.10.6.6/32
Wed Dec 21 08:45:29.287 UTC
10.10.6.6/32, version 102, labeled SR, internal 0x1000001 0x83 (ptr 0xa141688c) [1], 0x0 (0xa13f8aa8), 0xa28 (0xa1a6e0b8)
 Updated Dec 21 04:01:24.424
 local adjacency 172.16.1.2
 Prefix Len 32, traffic index 0, precedence n/a, priority 1
   via 172.16.1.2/32, GigabitEthernet0/0/0/0, 10 dependencies, weight 0, class 0, protected, ECMP-backup (Local-LFA) [flags 0x600]
    path-idx 0 bkup-idx 1 NHID 0x0 [0xa1900450 0x0]
    next hop 172.16.1.2/32
     local label 16006      labels imposed {16006}
   via 172.16.3.3/32, GigabitEthernet0/0/0/1, 11 dependencies, weight 0, class 0, protected, ECMP-backup (Local-LFA) [flags 0x600]
    path-idx 1 bkup-idx 0 NHID 0x0 [0xa1900570 0x0]
    next hop 172.16.3.3/32
     local label 16006      labels imposed {16006}


RP/0/0/CPU0:XR1#show route 10.10.6.6/32
Wed Dec 21 08:47:03.281 UTC

Routing entry for 10.10.6.6/32
  Known via "ospf 100", distance 110, metric 4, labeled SR, type intra area
  Installed Dec 21 04:01:24.405 for 04:45:38
  Routing Descriptor Blocks
    172.16.1.2, from 10.10.6.6, via GigabitEthernet0/0/0/0, Protected, ECMP-Backup (Local-LFA)
      Route metric is 4
    172.16.3.3, from 10.10.6.6, via GigabitEthernet0/0/0/1, Protected, ECMP-Backup (Local-LFA)
      Route metric is 4
  No advertising protos.


# autorouteを有効化し、SR-TEを使うようにする


segment-routing
 traffic-eng
  policy XR1-to-XR6
   autoroute
    include all
   !
  !
 !
!
end


# SR-TE Policyを使うようになっている

RP/0/0/CPU0:XR1#show route 10.10.6.6/32
Wed Dec 21 08:56:41.261 UTC

Routing entry for 10.10.6.6/32
  Known via "ospf 100", distance 110, metric 4, labeled SR, label redist non FIB, type intra area
  Installed Dec 21 08:49:18.331 for 00:07:22
  Routing Descriptor Blocks
    10.10.6.6, from 10.10.6.6, via srte_c_100_ep_10.10.6.6
      Route metric is 4
  No advertising protos.
RP/0/0/CPU0:XR1#show cef 10.10.6.6/32
Wed Dec 21 08:57:01.430 UTC
10.10.6.6/32, version 109, labeled SR, internal 0x1000001 0x83 (ptr 0xa141688c) [1], 0x0 (0xa13f8aa8), 0xa20 (0xa175739c)
 Updated Oct 23 21:30:21.501
 Prefix Len 32, traffic index 0, precedence n/a, priority 1
 Extensions: context-label:16006
   via 10.10.6.6/32, srte_c_100_ep_10.10.6.6, 7 dependencies, weight 0, class 0 [flags 0x0]
    path-idx 0 NHID 0x0 [0xa189b690 0x0]
    next hop 10.10.6.6/32
    local adjacency
     labels imposed {None}


# ASAvにトラフィックを曲げる
 segment-routing
        traffic-eng
         segment-list XR1-ASA-XR6
          index 10 address ipv4 10.10.3.3
          index 20 address ipv4 10.10.4.4
          index 30 address ipv4 172.16.8.6


# 勝手にAdjーSIDが使われる！！これは便利
RP/0/0/CPU0:XR1#show segment-routing traffic-eng policy detail
Thu Dec 22 03:15:26.945 UTC

SR-TE policy database
---------------------

Color: 100, End-point: 10.10.6.6
  Name: srte_c_100_ep_10.10.6.6
  Status:
    Admin: up  Operational: up for 23:14:02 (since Dec 21 04:01:24.755)
  Candidate-paths:
    Preference: 100 (configuration) (current)
      Name: XR1-to-XR6
      Requested BSID: dynamic
      Explicit: segment-list XR1-ASA-XR6 (valid)
        Weight: 1, Metric Type: TE
          16003 [Prefix-SID, 10.10.3.3]
          16004 [Prefix-SID, 10.10.4.4]
          24014 [Adjacency-SID, 172.16.8.4 - 172.16.8.6]
  LSPs:
    LSP[0]:
      LSP-ID: 1 policy ID: 1
      Local label: 24000
      State: Cleanup timer pending
    LSP[1]:
      LSP-ID: 2 policy ID: 1 (current)
      Local label: 24005
      State: Programmed
      Binding SID: 24001
  Attributes:
    Binding SID: 24001
    Forward Class: 0
    Steering BGP disabled: no
    IPv6 caps enable: yes


# Binding SID=SR-TE Policy自体に割り当てられたSIDをBinding SIDという
# https://y-network.jp/2020/07/31/segment-routing-024/


# XR1-ASA-XR6のBinding SIDは24001

RP/0/0/CPU0:XR1#show segment-routing traffic-eng policy
Thu Dec 22 03:28:14.712 UTC

SR-TE policy database
---------------------

Color: 100, End-point: 10.10.6.6
  Name: srte_c_100_ep_10.10.6.6
  Status:
    Admin: up  Operational: up for 23:26:49 (since Dec 21 04:01:24.755)
  Candidate-paths:
    Preference: 100 (configuration) (current)
      Name: XR1-to-XR6
      Requested BSID: dynamic
      Explicit: segment-list XR1-ASA-XR6 (valid)
        Weight: 1, Metric Type: TE
          16003 [Prefix-SID, 10.10.3.3]
          16004 [Prefix-SID, 10.10.4.4]
          24014 [Adjacency-SID, 172.16.8.4 - 172.16.8.6]
  Attributes:
    Binding SID: 24001
    Forward Class: 0
    Steering BGP disabled: no
    IPv6 caps enable: yes


# forwarding table上も24001がTEに使われている

RP/0/0/CPU0:XR1#show mpls for
Thu Dec 22 03:27:38.245 UTC
Local  Outgoing    Prefix             Outgoing     Next Hop        Bytes
Label  Label       or ID              Interface                    Switched
------ ----------- ------------------ ------------ --------------- ------------
16002  Pop         SR Pfx (idx 2)     Gi0/0/0/0    172.16.1.2      0
       16006       SR Pfx (idx 2)     Gi0/0/0/1    172.16.3.3      0            (!)
16003  Pop         SR Pfx (idx 3)     Gi0/0/0/1    172.16.3.3      0
       16006       SR Pfx (idx 3)     Gi0/0/0/0    172.16.1.2      0            (!)
16004  16004       SR Pfx (idx 4)     Gi0/0/0/1    172.16.3.3      0
       16006       SR Pfx (idx 4)     Gi0/0/0/0    172.16.1.2      0            (!)
16005  16005       SR Pfx (idx 5)     Gi0/0/0/0    172.16.1.2      0
       16006       SR Pfx (idx 5)     Gi0/0/0/1    172.16.3.3      0            (!)
16006  16006       SR Pfx (idx 6)     Gi0/0/0/1    172.16.3.3      0
       16006       SR Pfx (idx 6)     Gi0/0/0/0    172.16.1.2      0
24001  Pop         No ID              srte_c_100_e point2point     0
24002  Unlabelled  172.16.2.0/24      Gi0/0/0/0    172.16.1.2      0
       16006       172.16.2.0/24      Gi0/0/0/1    172.16.3.3      0            (!)
24003  Unlabelled  172.16.4.0/24      Gi0/0/0/1    172.16.3.3      0
       16006       172.16.4.0/24      Gi0/0/0/0    172.16.1.2      0            (!)
24004  Pop         10.10.6.6/32       srte_c_100_e 10.10.6.6       0
24010  Pop         SR Adj (idx 0)     Gi0/0/0/0    172.16.1.2      0
24011  Pop         SR Adj (idx 0)     Gi0/0/0/1    172.16.3.3      0
24012  Pop         SR Adj (idx 0)     Gi0/0/0/0    172.16.1.2      0
       16006       SR Adj (idx 0)     Gi0/0/0/1    172.16.3.3      0            (!)
24013  Pop         SR Adj (idx 0)     Gi0/0/0/1    172.16.3.3      0
       16006       SR Adj (idx 0)     Gi0/0/0/0    172.16.1.2      0            (!)


# Binding SIDは手動で設定も可能

segment-routing
 traffic-eng
  policy XR1-to-XR6
   binding-sid mpls 1006


# Binding SIDが変わっている
RP/0/0/CPU0:XR1#show segment-routing traffic-eng policy
Thu Dec 22 03:57:16.583 UTC

SR-TE policy database
---------------------

Color: 100, End-point: 10.10.6.6
  Name: srte_c_100_ep_10.10.6.6
  Status:
    Admin: up  Operational: up for 23:55:51 (since Dec 21 04:01:24.755)
  Candidate-paths:
    Preference: 100 (configuration) (current)
      Name: XR1-to-XR6
      Requested BSID: 1006
      Explicit: segment-list XR1-ASA-XR6 (valid)
        Weight: 1, Metric Type: TE
          16003 [Prefix-SID, 10.10.3.3]
          16004 [Prefix-SID, 10.10.4.4]
          24014 [Adjacency-SID, 172.16.8.4 - 172.16.8.6]
  Attributes:
    Binding SID: 1006
    Forward Class: 0
    Steering BGP disabled: no
    IPv6 caps enable: yes


RP/0/0/CPU0:XR1#show mpls forwarding
Thu Dec 22 03:58:36.817 UTC
Local  Outgoing    Prefix             Outgoing     Next Hop        Bytes
Label  Label       or ID              Interface                    Switched
------ ----------- ------------------ ------------ --------------- ------------
1006   Pop         No ID              srte_c_100_e point2point     0
16002  Pop         SR Pfx (idx 2)     Gi0/0/0/0    172.16.1.2      0
       16006       SR Pfx (idx 2)     Gi0/0/0/1    172.16.3.3      0            (!)
16003  Pop         SR Pfx (idx 3)     Gi0/0/0/1    172.16.3.3      0
       16006       SR Pfx (idx 3)     Gi0/0/0/0    172.16.1.2      0            (!)
16004  16004       SR Pfx (idx 4)     Gi0/0/0/1    172.16.3.3      0
       16006       SR Pfx (idx 4)     Gi0/0/0/0    172.16.1.2      0            (!)
16005  16005       SR Pfx (idx 5)     Gi0/0/0/0    172.16.1.2      0
       16006       SR Pfx (idx 5)     Gi0/0/0/1    172.16.3.3      0            (!)
16006  16006       SR Pfx (idx 6)     Gi0/0/0/1    172.16.3.3      0
       16006       SR Pfx (idx 6)     Gi0/0/0/0    172.16.1.2      0
24002  Unlabelled  172.16.2.0/24      Gi0/0/0/0    172.16.1.2      0
       16006       172.16.2.0/24      Gi0/0/0/1    172.16.3.3      0            (!)
24003  Unlabelled  172.16.4.0/24      Gi0/0/0/1    172.16.3.3      0
       16006       172.16.4.0/24      Gi0/0/0/0    172.16.1.2      0            (!)
24004  Pop         10.10.6.6/32       srte_c_100_e 10.10.6.6       0
24010  Pop         SR Adj (idx 0)     Gi0/0/0/0    172.16.1.2      0
24011  Pop         SR Adj (idx 0)     Gi0/0/0/1    172.16.3.3      0
24012  Pop         SR Adj (idx 0)     Gi0/0/0/0    172.16.1.2      0
       16006       SR Adj (idx 0)     Gi0/0/0/1    172.16.3.3      0            (!)
24013  Pop         SR Adj (idx 0)     Gi0/0/0/1    172.16.3.3      0
       16006       SR Adj (idx 0)     Gi0/0/0/0    172.16.1.2      0            (!)



# Dynamic Pathを使ったSR-TE

# XR-3,4でMetricを変更する

At XR3:
      segment-routing
       traffic-eng
        interface GigabitEthernet0/0/0/1  
          metric 10

At XR4:
      segment-routing
       traffic-eng
        interface GigabitEthernet0/0/0/0
          metric 10





# Node3, Node4のLINKのLINKのTE Metricが増えている
RP/0/0/CPU0:XR1#show segment-routing traffic-eng ipv4 topology

Node 3
  TE router ID: 10.10.3.3
  OSPF router ID: 10.10.3.3 area ID: 0
  Prefix SID:
    Prefix 10.10.3.3, label 16003 (regular)

  Link[0]: local address 172.16.3.3, remote address 172.16.3.1
    Local node:
      OSPF router ID: 10.10.3.3 area ID: 0
    Remote node:
      TE router ID: 10.10.1.1
      OSPF router ID: 10.10.1.1 area ID: 0
    Metric: IGP 1, TE 1
    Bandwidth: Total link 125000000, Reservable 0
    Admin-groups: 0x00000000
    Adj SID: 24012 (protected) 24010 (unprotected)

  Link[1]: local address 172.16.4.3, remote address 172.16.4.4
    Local node:
      OSPF router ID: 10.10.3.3 area ID: 0
    Remote node:
      TE router ID: 10.10.4.4
      OSPF router ID: 10.10.4.4 area ID: 0
    Metric: IGP 1, TE 10
    Bandwidth: Total link 125000000, Reservable 0
    Admin-groups: 0x00000000
    Adj SID: 24013 (protected) 24011 (unprotected)

Node 4
  TE router ID: 10.10.5.5
  OSPF router ID: 10.10.5.5 area ID: 0
  Prefix SID:
    Prefix 10.10.5.5, label 16005 (regular)

  Link[0]: local address 172.16.2.5, remote address 172.16.2.2
    Local node:
      OSPF router ID: 10.10.5.5 area ID: 0
    Remote node:
      TE router ID: 10.10.2.2
      OSPF router ID: 10.10.2.2 area ID: 0
    Metric: IGP 1, TE 1
    Bandwidth: Total link 125000000, Reservable 0
    Admin-groups: 0x00000000
    Adj SID: 24012 (protected) 24010 (unprotected)

  Link[1]: local address 172.16.5.5, remote address 172.16.5.6
    Local node:
      OSPF router ID: 10.10.5.5 area ID: 0
    Remote node:
      TE router ID: 10.10.6.6
      OSPF router ID: 10.10.6.6 area ID: 0
    Metric: IGP 1, TE 1
    Bandwidth: Total link 125000000, Reservable 0
    Admin-groups: 0x00000000
    Adj SID: 24013 (protected) 24011 (unprotected)


# xr-1 color 200でdynamic metric TEを使う設定
segment-routing
        traffic-eng
         policy XR1-up-XR6
          color 200 end-point ipv4 10.10.6.6
          candidate-paths
           preference 100
            dynamic
              metric
                type te


# Color 200でポリシーが設定されている

RP/0/0/CPU0:XR1#show segment-routing traffic-eng policy color 200
Thu Dec 22 09:50:27.111 UTC

SR-TE policy database
---------------------

Color: 200, End-point: 10.10.6.6
  Name: srte_c_200_ep_10.10.6.6
  Status:
    Admin: up  Operational: up for 00:05:28 (since Dec 22 09:44:58.874)
  Candidate-paths:
    Preference: 100 (configuration) (current)
      Name: XR1-up-XR6
      Requested BSID: dynamic
      Dynamic (valid)
        Metric Type: TE,   Path Accumulated Metric: 3
          16005 [Prefix-SID, 10.10.5.5]
          16006 [Prefix-SID, 10.10.6.6]
  Attributes:
    Binding SID: 24005
    Forward Class: 0
    Steering BGP disabled: no
    IPv6 caps enable: yes


# ここまでで、color: 100のexplicit pathとcolor 200のdynamic pathの２つ設定した
# L3VPNを設定し、BGPでcolorを広報し、どのPathを使うか設定する

# automatic steeringでSR-TEするので、autorouteはdisableする
segment-routing
 traffic-eng
  policy XR1-to-XR6
   no autoroute



# xr-1, xr-6にL3VPN関連の設定をする

vrf vrf100
 rd 100:100
 address-family ipv4 unicast
  import route-target
   100:100
  !
  export route-target
   100:100
  !
 !
!
interface Loopback100
 vrf vrf100
 ipv4 address 100.1.1.1 255.255.255.255
!
router bgp 100
 bgp router-id 10.10.1.1
 address-family vpnv4 unicast
 !
 neighbor 10.10.6.6
  remote-as 100
  update-source Loopback0
  address-family vpnv4 unicast


# xr-6から見て、BGP VPNv4が貼れている

RP/0/0/CPU0:XR6#show bgp vpnv4 unicast
Thu Dec 22 10:30:44.717 UTC
BGP router identifier 10.10.6.6, local AS number 100
BGP generic scan interval 60 secs
Non-stop routing is enabled
BGP table state: Active
Table ID: 0x0   RD version: 0
BGP main routing table version 8
BGP NSR Initial initsync version 7 (Reached)
BGP NSR/ISSU Sync-Group versions 0/0
BGP scan interval 60 secs

Status codes: s suppressed, d damped, h history, * valid, > best
              i - internal, r RIB-failure, S stale, N Nexthop-discard
Origin codes: i - IGP, e - EGP, ? - incomplete
   Network            Next Hop            Metric LocPrf Weight Path
Route Distinguisher: 100:100 (default for vrf vrf100)
*>i100.1.1.1/32       10.10.1.1                0    100      0 ?
*> 100.6.6.6/32       0.0.0.0                  0         32768 ?


# xr-6側でルートにColorをつける


vrf vrf100
 address-family ipv4 unicast
  export route-policy COLOR100
 !
!
!
extcommunity-set opaque COLOR100
  100
end-set
!
route-policy COLOR100
  set extcommunity color COLOR100
end-policy



# xr-1から見ると、100.10.6.6への経路color:100が付いている

RP/0/0/CPU0:XR1#show bgp vpnv4 unicast
Thu Dec 22 10:55:12.825 UTC
BGP router identifier 10.10.1.1, local AS number 100
BGP generic scan interval 60 secs
Non-stop routing is enabled
BGP table state: Active
Table ID: 0x0   RD version: 0
BGP main routing table version 7
BGP NSR Initial initsync version 4 (Reached)
BGP NSR/ISSU Sync-Group versions 0/0
BGP scan interval 60 secs

Status codes: s suppressed, d damped, h history, * valid, > best
              i - internal, r RIB-failure, S stale, N Nexthop-discard
Origin codes: i - IGP, e - EGP, ? - incomplete
   Network            Next Hop            Metric LocPrf Weight Path
Route Distinguisher: 100:100 (default for vrf vrf100)
*> 100.1.1.1/32       0.0.0.0                  0         32768 ?
*>i100.6.6.6/32       10.10.6.6 C:100          0    100      0 ?




RP/0/0/CPU0:XR1#sh bgp vpnv4 uni rd 100:100 100.6.6.6/32 det
Thu Dec 22 10:59:06.489 UTC
BGP routing table entry for 100.6.6.6/32, Route Distinguisher: 100:100
Versions:
  Process           bRIB/RIB  SendTblVer
  Speaker                  7           7
    Flags: 0x00043001+0x00000000;
Last Modified: Dec 22 10:50:36.724 for 00:08:29
Paths: (1 available, best #1)
  Not advertised to any peer
  Path #1: Received by speaker 0
  Flags: 0x4000000085060005, import: 0x9f
  Not advertised to any peer
  Local
    10.10.6.6 C:100 (bsid:1006) (metric 4) from 10.10.6.6 (10.10.6.6)
      Received Label 24000
      Origin incomplete, metric 0, localpref 100, valid, internal, best, group-best, import-candidate, imported
      Received Path ID 0, Local Path ID 1, version 7
      Extended community: Color:100 RT:100:100
      SR policy color 100, up, not-registered, bsid 1006

      Source AFI: VPNv4 Unicast, Source VRF: vrf100, Source Route Distinguisher: 100:100



# cefを見ても、color 100 のSR-TE Policyを使うようになっている。1006は手動設定したBinding-SID

RP/0/0/CPU0:XR1#show cef vrf vrf100 100.6.6.6/32 detail
Thu Dec 22 11:07:27.415 UTC
100.6.6.6/32, version 5, internal 0x5000001 0x0 (ptr 0xa1416cec) [1], 0x0 (0x0), 0x208 (0xa1757318)
 Updated Dec 22 10:50:36.705
 Prefix Len 32, traffic index 0, precedence n/a, priority 3
  gateway array (0xa1350358) reference count 1, flags 0x2038, source rib (7), 0 backups
                [1 type 1 flags 0x48441 (0xa1773958) ext 0x0 (0x0)]
  LW-LDI[type=0, refc=0, ptr=0x0, sh-ldi=0x0]
  gateway array update type-time 1 Dec 22 10:50:36.705
 LDI Update time Dec 22 10:50:36.705
   via local-label 1006, 3 dependencies, recursive [flags 0x6000]
    path-idx 0 NHID 0x0 [0xa17cb70c 0x0]
    recursion-via-label
    next hop VRF - 'default', table - 0xe0000000
    next hop via 1006/0/21
     next hop srte_c_100_e labels imposed {ImplNull 24000}


    Load distribution: 0 (refcount 1)

    Hash  OK  Interface                 Address
    0     Y   Unknown                   1006/0



RP/0/0/CPU0:XR1#show segment-routing traffic-eng policy color 100
Thu Dec 22 11:11:14.189 UTC

SR-TE policy database
---------------------

Color: 100, End-point: 10.10.6.6
  Name: srte_c_100_ep_10.10.6.6
  Status:
    Admin: up  Operational: up for 01:30:36 (since Dec 22 09:40:37.612)
  Candidate-paths:
    Preference: 100 (configuration) (current)
      Name: XR1-to-XR6
      Requested BSID: 1006
      Explicit: segment-list XR1-ASA-XR6 (valid)
        Weight: 1, Metric Type: TE
          16003 [Prefix-SID, 10.10.3.3]
          16004 [Prefix-SID, 10.10.4.4]
          24014 [Adjacency-SID, 172.16.8.4 - 172.16.8.6]
  Attributes:
    Binding SID: 1006
    Forward Class: 0
    Steering BGP disabled: no
    IPv6 caps enable: yes



# ちゃんとカウンターも増える
# Policy Packets/Bytes Switched

RP/0/0/CPU0:XR1#show segment-routing traffic-eng forwarding policy color 100 detail
Thu Dec 22 11:13:25.080 UTC
Color Endpoint        Segment      Outgoing Outgoing     Next Hop     Bytes
                      List         Label    Interface                 Switched
----- --------------- ------------ -------- ------------ ------------ ------------
100   10.10.6.6       XR1-ASA-XR6  16006    Gi0/0/0/0    172.16.1.2   0           (!)
                 Label Stack (Top -> Bottom): { 16006, 16003, 16004, 24014 }
                 Path-id: 1 (Pure-Backup), Weight: 64
                 Packets Switched: 0
                                   16004    Gi0/0/0/1    172.16.3.3   0
                 Label Stack (Top -> Bottom): { 16004, 24014 }
                 Path-id: 2 (Protected), Backup-path-id: 1, Weight: 64
                 Packets Switched: 0
   Local label: 24000
   Policy Packets/Bytes Switched: 26/2048
   (!): FRR pure backup

RP/0/0/CPU0:XR1#ping vrf vrf100 100.6.6.6 source 100.1.1.1
Thu Dec 22 11:13:51.778 UTC
Type escape sequence to abort.
Sending 5, 100-byte ICMP Echos to 100.6.6.6, timeout is 2 seconds:
!!!!!
Success rate is 100 percent (5/5), round-trip min/avg/max = 1/7/9 ms
RP/0/0/CPU0:XR1#show segment-routing traffic-eng forwarding policy color 100 detail
Thu Dec 22 11:13:53.788 UTC
Color Endpoint        Segment      Outgoing Outgoing     Next Hop     Bytes
                      List         Label    Interface                 Switched
----- --------------- ------------ -------- ------------ ------------ ------------
100   10.10.6.6       XR1-ASA-XR6  16006    Gi0/0/0/0    172.16.1.2   0           (!)
                 Label Stack (Top -> Bottom): { 16006, 16003, 16004, 24014 }
                 Path-id: 1 (Pure-Backup), Weight: 64
                 Packets Switched: 0
                                   16004    Gi0/0/0/1    172.16.3.3   540
                 Label Stack (Top -> Bottom): { 16004, 24014 }
                 Path-id: 2 (Protected), Backup-path-id: 1, Weight: 64
                 Packets Switched: 5
   Local label: 24000
   Policy Packets/Bytes Switched: 31/2568
   (!): FRR pure backup
